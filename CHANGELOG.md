# 漂流瓶系统 - 功能更新日志

## 最新版本 (v1.0.2) - 2025年4月21日

### 功能变更
- **取消使用伪静态功能**
  - 修改nginx.htaccess配置文件，注释掉伪静态转发规则
  - 清空.htaccess文件，彻底取消Apache伪静态规则
  - 修改前端JavaScript API调用，从使用伪静态路径格式改为传统的GET参数格式
  - 增强前端代码错误处理和调试功能，提高系统稳定性
  - 改进表单提交验证，增加防护检查机制

### 问题修复
- 修复注册页面中表单ID不匹配问题，确保输入验证正确工作
- 修复API调用路径，将所有`api.php/endpoint`格式的调用改为`api.php?action=endpoint`格式
- 增加错误日志和调试信息，提供更详细的问题排查支持
- 增强JavaScript代码的健壮性，添加必要的错误捕获和空值检查

## 版本 (v1.0.1) - 2025年4月20日

### 新增功能
- **增强安全功能**
  - 增强了sanitizeInput函数，使用更严格的参数
  - 添加了专门的HTML过滤函数sanitizeHtml，允许基本HTML标签但过滤危险内容
  - 添加了URL过滤函数sanitizeUrl
  - 添加了SQL过滤函数sanitizeSql
  - 创建了完整的安全中间件类Security，提供了
    - 内容安全策略（CSP）设置
    - 安全相关的HTTP响应头
    - 会话固定攻击防护
    - CSRF令牌生成和验证
    - 输入验证和过滤
    - 恶意输入检测
  - 在API处理流程中增加了恶意输入检测
  - 为常用API端点增加了详细的验证规则
  - 前端添加了CSRF令牌处理工具以及获取CSRF令牌的API端点
  - 增强了 Security 类：
    - 扩展了恶意模式检测，添加更多XSS和SQL注入模式
    - 添加了更严格的HTML净化函数 purifyHtml
    - 添加了JSON数据过滤和安全输出功能
  - 改进了基本过滤函数：
    - 为所有过滤函数添加了类型检查
    - 增强了URL过滤，阻止更多危险协议
    - 集成了高级HTML过滤
  - 添加了专门的验证器类 Validator：
    - 提供了对用户名、密码、URL、电子邮件等的高级验证
    - 实现了文本和HTML内容的验证和长度检查
    - 添加了密码强度评估
  - 优化了API处理：
    - 使用安全输出JSON函数
    - 记录潜在的攻击尝试
    - 改进了CORS和预检请求处理

- **新增账号封禁功能**
  - 管理员可以控制账号是否允许登陆
  - 已运行用户使用update_user_status.sql新增数据表

- **VIP会员系统**
  - 实现VIP会员购买和续费功能
  - VIP会员享有更高的漂流瓶发送配额
  - VIP会员特权标识和界面优化
  - VIP到期自动检测和状态更新

- **用户签到系统**
  - 每日签到获取积分奖励
  - 连续签到奖励增加
  - 签到统计（月度签到次数、连续签到天数）

- **个性化设置**
  - 用户可以设置个性签名，展示在个人资料页
  - 个性签名字数限制为50字

- **积分系统**
  - 用户可通过多种方式获取积分（签到、互动等）
  - 积分历史记录
  - 积分用途扩展

- **漂流瓶功能增强**
  - 评论功能优化，支持实时评论
  - 对漂流瓶添加点赞功能
  - 匿名发送选项
  - 漂流瓶发送频率限制

- **UI/UX改进**
  - 响应式界面优化，提升移动端体验
  - 漂流瓶性别区分（蓝色表示男性，粉色表示女性）
  - 交互反馈优化
  - 导航栏状态根据登录状态动态更新

- **安全性增强**
  - IP地址记录与保护
  - 非VIP用户IP地址部分隐藏
  - 后端验证增强

### 优化改进
- 使用MutationObserver监听DOM变化，优化漂流瓶交互体验
- 优化API响应结构，提高前端数据处理效率
- 漂流瓶存储结构优化

### 问题修复
- 修复用户签名更新后不显示的问题
- 修复VIP状态检测逻辑
- 修复漂流瓶评论按钮事件绑定问题

## 计划中的功能
- 漂流瓶内容分类系统
- 用户间私信功能
- 漂流瓶收藏功能
- 更多的用户个性化设置
- 用户等级系统 