# 故障排除与 Bug 修复记录

本文档记录了系统中发现并修复的问题、性能优化内容以及常见故障的解决方案。

## 快速问题排查

### 页面无法访问

1. 检查 Web 服务器是否运行
2. 检查 PHP 是否正常运行
3. 查看 Web 服务器错误日志
4. 检查文件权限

### 数据库连接失败

1. 检查 `includes/config.php` 中的数据库配置
2. 确认 MySQL 服务正在运行
3. 检查数据库用户权限
4. 测试数据库连接：`mysql -u username -p database_name`

### 功能异常

1. 打开浏览器开发者工具 (F12)
2. 查看控制台 (Console) 错误信息
3. 查看网络 (Network) 请求状态
4. 检查服务器错误日志 (`logs/php_errors.log`)

## Bug 修复记录

### 2024-12-23 分页功能修复

**问题描述：**
- 分页功能失效，点击第二页后内容无变化
- 两个页面（我扔出的漂流瓶、我捡到的漂流瓶）都有此问题

**问题原因：**
- `renderPagination` 函数的参数名 `currentPage` 遮蔽了全局变量
- 事件处理器中无法正确访问和修改全局变量 `currentPage`
- 每次调用 `renderPagination` 时重复绑定事件监听器

**修复方案：**
1. 将 `renderPagination` 的参数名改为 `pageNum`，避免遮蔽全局变量
2. 使用事件委托，避免重复绑定事件监听器
3. 添加页面范围检查，确保 `currentPage` 不会超出总页数

**修改文件：**
- `profile_picked.html`
- `profile_bottles.html`

### 2024-12-23 评论显示功能

**问题描述：**
- "我捡到的漂流瓶"页面不显示评论内容

**修复方案：**
1. 修改 `getUserPickedBottles` 函数，为每个漂流瓶获取评论列表
2. 在前端页面添加评论显示区域
3. 添加 HTML 转义函数，防止 XSS 攻击

**修改文件：**
- `includes/bottle.php`
- `profile_picked.html`

### 2024-12-20 性能优化与 Bug 修复

#### 1. 丢出漂流瓶时 JSON 解析错误

**问题描述：**
- 丢出漂流瓶时出现 `JSON.parse: unexpected character at line 1 column 5 of the JSON data` 错误
- 导致用户无法正常丢出漂流瓶

**问题原因：**
1. `Security::outputJson` 方法未检查 `json_encode` 是否成功
2. `throw.html` 直接调用 `response.json()`，未检查响应状态和内容类型
3. PHP 错误或警告可能在 JSON 输出之前输出，破坏 JSON 格式

**修复方案：**

**文件：`includes/security.php`**
- 添加输出缓冲清理，防止意外输出
- 添加 JSON 编码错误检查
- 编码失败时返回错误信息而不是 `false`

**文件：`api.php`**
- 在文件开头开启输出缓冲
- 在设置 JSON 响应头之前清除输出缓冲区
- 禁用错误显示但保留错误日志

**文件：`throw.html`**
- 添加 HTTP 响应状态检查
- 添加 Content-Type 检查
- 改进 JSON 解析错误处理和日志记录

**修复效果：**
- ✅ 解决了 JSON 解析错误问题
- ✅ 改进了错误处理和日志记录
- ✅ 提高了代码的健壮性

#### 2. 页面加载性能优化

**问题描述：**
- `throw.html`、`pick.html`、`profile.html` 页面加载缓慢
- 多个 API 调用串行执行，总等待时间长

**优化方案：**

**并行化 API 调用**
- 使用 `Promise.allSettled` 并行执行多个请求
- 关键数据并行加载，非关键数据延迟加载

**避免重复初始化**
- 页面设置 `window.pageHasCustomInit` 标志
- `app.js` 检测到后跳过重复初始化

**降低超时时间**
- IP 查询超时从 5 秒降至 2 秒
- 失败时快速回退到本地查询

**优化效果：**

| 页面 | 优化前 | 优化后 | 性能提升 |
|------|--------|--------|----------|
| throw.html | ~3-5 秒 | ~0.5-1 秒 | **70-80%** |
| pick.html | ~2-3 秒 | ~0.5-1 秒 | **60-70%** |
| profile.html | ~5-7 秒 | ~1-2 秒 | **70-80%** |

**修改文件：**
- `throw.html`
- `pick.html`
- `profile.html`
- `assets/js/app.js`
- `includes/ip_location.php`

## 常见问题解决方案

### 语音功能无法使用

**症状：**
- 无法录音
- 音频无法播放
- 上传失败

**解决方案：**

1. **无法录音**
   - 检查浏览器是否支持 `MediaRecorder API`
   - 确认已授权麦克风权限
   - 检查是否为HTTPS环境（生产环境要求）
   - 查看浏览器控制台错误信息

2. **音频无法播放**
   - 检查音频文件路径是否正确
   - 确认 `uploads/audio/` 目录权限（755 或 777）
   - 检查浏览器是否支持音频格式
   - 检查文件是否完整上传

3. **上传失败**
   - 检查文件大小是否超过5MB限制
   - 确认服务器 `uploads/audio/` 目录写入权限
   - 检查PHP `upload_max_filesize` 和 `post_max_size` 配置
   - 查看服务器错误日志

### 分页功能异常

**症状：**
- 点击分页无反应
- 显示内容不正确
- 分页信息错误

**解决方案：**

1. **点击无反应**
   - 打开浏览器控制台查看是否有 JavaScript 错误
   - 检查事件监听器是否正确绑定
   - 清除浏览器缓存

2. **显示内容不正确**
   - 检查 `currentPage` 变量是否正确更新
   - 检查数据过滤逻辑是否正确
   - 查看网络请求返回的数据

3. **分页信息错误**
   - 检查总页数计算是否正确
   - 检查当前页是否超出范围
   - 查看分页渲染逻辑

### API 调用失败

**症状：**
- API 返回错误
- 请求超时
- 返回非 JSON 格式

**解决方案：**

1. **检查请求格式**
   - 确认使用 `api.php?action=endpoint_name` 格式
   - 检查请求方法（GET/POST）是否正确
   - 检查请求参数是否正确

2. **检查服务器响应**
   - 打开浏览器开发者工具查看网络请求
   - 检查响应状态码
   - 检查响应内容类型是否为 `application/json`

3. **查看错误日志**
   - 检查 `logs/php_errors.log`
   - 检查 Web 服务器错误日志
   - 检查浏览器控制台错误

### 数据库相关问题

**症状：**
- 数据库连接失败
- 查询错误
- 数据不一致

**解决方案：**

1. **连接失败**
   - 检查 `includes/config.php` 中的数据库配置
   - 确认 MySQL 服务正在运行
   - 检查数据库用户权限
   - 测试数据库连接

2. **查询错误**
   - 查看 PHP 错误日志
   - 检查 SQL 语句是否正确
   - 检查表结构是否完整
   - 确认已执行所有必要的数据库更新脚本

3. **数据不一致**
   - 检查数据库事务是否正确提交
   - 检查是否有并发问题
   - 查看操作日志

## 性能优化建议

### 前端优化

1. **减少 API 调用**
   - 合并多个 API 调用
   - 使用并行请求替代串行请求
   - 缓存不经常变化的数据

2. **优化资源加载**
   - 压缩 JavaScript 和 CSS 文件
   - 使用 CDN 加载静态资源
   - 延迟加载非关键资源

3. **改进用户体验**
   - 添加加载提示
   - 使用骨架屏
   - 优化页面渲染

### 后端优化

1. **数据库优化**
   - 添加必要的索引
   - 优化查询语句
   - 使用连接池

2. **缓存机制**
   - 缓存系统配置
   - 缓存用户信息
   - 使用 Redis 等缓存系统

3. **代码优化**
   - 减少不必要的数据库查询
   - 优化循环和条件判断
   - 使用适当的数据结构

## 日志分析

### PHP 错误日志

位置：`logs/php_errors.log`

常见错误类型：
- 语法错误
- 数据库连接错误
- 文件权限错误
- 内存不足

### 浏览器控制台

常见错误类型：
- JavaScript 语法错误
- API 请求失败
- 资源加载失败
- 跨域问题

### 网络请求分析

使用浏览器开发者工具的 Network 选项卡：
- 检查请求状态码
- 查看请求和响应内容
- 分析请求耗时
- 识别慢请求

## 联系支持

如果遇到无法解决的问题，请：

1. 查看本文档的故障排除部分
2. 查看 [GitHub Issues](https://github.com/kggzs/Driftbottle/issues)
3. 提供详细的错误信息和日志
4. 联系技术支持：QQ 1724464998

## 更新日志

- **2024-12-23**: 分页功能修复、评论显示功能
- **2024-12-20**: JSON 解析错误修复、页面性能优化

