# 支付系统使用说明

## 目录
- [功能概述](#功能概述)
- [系统架构](#系统架构)
- [配置说明](#配置说明)
- [支付流程](#支付流程)
- [API接口](#api接口)
- [数据库结构](#数据库结构)
- [常见问题](#常见问题)

---

## 功能概述

漂流瓶系统集成了在线支付功能，用户可以通过支付宝、微信支付、QQ钱包、云闪付等方式充值积分。系统支持：

- ✅ 多种支付方式（支付宝、微信支付、QQ钱包、云闪付）
- ✅ 可配置的支付方式显示
- ✅ 可配置的积分比例
- ✅ 订单管理和查询
- ✅ 支付回调处理（同步和异步）
- ✅ 充值记录查看

---

## 系统架构

### 文件结构

```
Driftbottle/
├── includes/
│   └── payment/
│       └── lib/
│           ├── epay.config.php          # 支付配置文件
│           └── EpayCore.class.php       # 支付核心类
├── payment_notify.php                   # 异步支付回调处理
├── payment_return.php                   # 同步支付返回处理
├── api.php                              # API接口（包含支付相关接口）
├── admin/
│   └── recharge_orders.php              # 后台订单管理
└── profile_info.html                    # 前端充值页面
```

### 支付流程

```
用户发起充值
    ↓
创建充值订单
    ↓
生成支付表单
    ↓
跳转到支付平台
    ↓
用户完成支付
    ↓
支付平台回调（异步/同步）
    ↓
验证签名并更新订单
    ↓
增加用户积分
    ↓
记录积分历史
```

---

## 配置说明

### 1. 数据库配置

首次使用需要执行数据库初始化脚本：

```sql
-- 执行 driftbottle.sql 或 sql/add_recharge_system.sql
```

脚本会自动创建：
- `recharge_orders` 表（充值订单表）
- 支付相关的系统设置项

### 2. 后台系统设置

登录后台管理系统，进入 **系统设置 → 支付配置**，配置以下参数：

#### 必填配置项

| 配置项 | 说明 | 示例值 |
|--------|------|--------|
| **充值积分比例** | 1元可以兑换多少积分 | 100 |
| **商户ID** | 支付平台分配的商户标识 | 1000 |
| **平台公钥** | 支付平台提供的公钥 | MIIBIjANBgkqhkiG... |
| **商户私钥** | 商户自己的私钥 | MIIEvAIBADANBgkqhkiG... |

#### 可选配置项

| 配置项 | 说明 | 默认值 | 可选值 |
|--------|------|--------|--------|
| **可用支付方式** | 用逗号分隔的支付方式列表 | alipay,wxpay,qqpay,bank | alipay, wxpay, qqpay, bank |
| **默认支付方式** | 用户打开充值弹窗时默认选中的支付方式 | alipay | alipay, wxpay, qqpay, bank |

#### 配置示例

**可用支付方式配置：**
```
alipay,wxpay        # 只显示支付宝和微信支付
alipay              # 只显示支付宝
alipay,wxpay,qqpay  # 显示支付宝、微信支付、QQ钱包
```

**默认支付方式配置：**
```
alipay    # 默认选中支付宝
wxpay     # 默认选中微信支付
```

### 3. 支付接口地址

支付接口地址已固定为：`https://pay.kggzs.cn/`

如需修改，请编辑 `includes/payment/lib/epay.config.php` 文件中的 `$apiurl` 变量。

---

## 支付流程

### 用户端充值流程

1. **进入充值页面**
   - 用户登录后，进入 **个人中心** 页面
   - 点击积分旁边的 **充值** 按钮

2. **填写充值信息**
   - 输入充值金额（最小：0.01元，最大：10000元）
   - 选择支付方式（支付宝/微信支付/QQ钱包/云闪付）
   - 查看预计获得的积分

3. **确认充值**
   - 点击 **确认充值** 按钮
   - 系统创建订单并跳转到支付平台

4. **完成支付**
   - 在支付平台完成支付
   - 支付成功后自动返回系统
   - 积分自动到账

### 订单状态说明

| 状态值 | 状态名称 | 说明 |
|--------|----------|------|
| 0 | 待支付 | 订单已创建，等待用户支付 |
| 1 | 已支付 | 支付成功，积分已到账 |
| 2 | 已取消 | 订单已取消 |
| 3 | 已退款 | 订单已退款 |

---

## API接口

### 1. 获取支付配置

**接口地址：** `api.php?action=get_payment_config`

**请求方式：** GET

**返回示例：**
```json
{
    "success": true,
    "points_ratio": 100,
    "available_methods": ["alipay", "wxpay", "qqpay", "bank"],
    "default_method": "alipay"
}
```

### 2. 创建充值订单

**接口地址：** `api.php?action=create_recharge_order`

**请求方式：** POST

**请求参数：**
```json
{
    "amount": 10.00,
    "payment_type": "alipay"
}
```

**返回示例：**
```json
{
    "success": true,
    "order_no": "R2026012810414299874",
    "amount": 10.00,
    "points": 1000,
    "pay_html": "<form id=\"dopay\" action=\"...\">...</form>"
}
```

### 3. 获取充值订单列表

**接口地址：** `api.php?action=get_recharge_orders`

**请求方式：** GET

**返回示例：**
```json
{
    "success": true,
    "orders": [
        {
            "id": 1,
            "order_no": "R2026012810414299874",
            "amount": "10.00",
            "points": 1000,
            "payment_type": "alipay",
            "status": 1,
            "created_at": "2026-01-28 10:41:42",
            "paid_at": "2026-01-28 10:42:15"
        }
    ]
}
```

---

## 数据库结构

### recharge_orders 表

充值订单表，用于存储所有充值订单信息。

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INT(11) | 主键，自增 |
| order_no | VARCHAR(50) | 商户订单号（唯一） |
| user_id | INT(11) | 用户ID（外键） |
| amount | DECIMAL(10,2) | 充值金额（元） |
| points | INT(11) | 获得的积分 |
| points_ratio | DECIMAL(10,2) | 积分比例（1元=多少积分） |
| payment_type | VARCHAR(20) | 支付方式（alipay/wxpay/qqpay/bank） |
| trade_no | VARCHAR(50) | 支付平台交易号 |
| status | TINYINT(1) | 订单状态（0-待支付，1-已支付，2-已取消，3-已退款） |
| notify_data | TEXT | 支付回调数据（JSON格式） |
| created_at | TIMESTAMP | 创建时间 |
| paid_at | TIMESTAMP | 支付时间 |
| updated_at | TIMESTAMP | 更新时间 |

### system_settings 表（支付相关配置）

| setting_key | 说明 |
|-------------|------|
| PAYMENT_POINTS_RATIO | 充值积分比例 |
| PAYMENT_MERCHANT_ID | 商户ID |
| PAYMENT_PLATFORM_PUBLIC_KEY | 平台公钥 |
| PAYMENT_MERCHANT_PRIVATE_KEY | 商户私钥 |
| PAYMENT_METHODS | 可用支付方式 |
| PAYMENT_DEFAULT_METHOD | 默认支付方式 |

---

## 常见问题

### Q1: 支付成功后积分没有到账？

**A:** 请检查以下几点：
1. 确认 `payment_notify.php` 文件可以正常访问（支付平台会异步回调此文件）
2. 检查服务器日志，查看是否有错误信息
3. 确认数据库连接正常
4. 检查支付配置是否正确（商户ID、公钥、私钥）

### Q2: 如何修改支付接口地址？

**A:** 编辑 `includes/payment/lib/epay.config.php` 文件，修改 `$apiurl` 变量：

```php
$apiurl = 'https://pay.kggzs.cn/'; // 修改为你的支付接口地址
```

### Q3: 如何只显示部分支付方式？

**A:** 在后台系统设置中，修改 **可用支付方式** 配置项：

```
只显示支付宝：alipay
只显示支付宝和微信：alipay,wxpay
```

### Q4: 如何修改积分比例？

**A:** 在后台系统设置中，修改 **充值积分比例** 配置项。例如设置为 `200`，表示 1元 = 200积分。

### Q5: 支付回调失败怎么办？

**A:** 
1. 检查 `payment_notify.php` 文件权限和路径
2. 确认服务器防火墙允许支付平台的IP访问
3. 查看服务器错误日志
4. 检查数据库连接和表结构是否正确

### Q6: 如何查看充值订单？

**A:** 
- **用户端：** 在个人中心页面，点击 **充值记录** 按钮查看
- **后台管理：** 进入 **充值订单** 页面，可以查看所有用户的订单，支持筛选和搜索

### Q7: 订单状态一直显示"待支付"？

**A:** 可能是异步回调未成功。系统会在用户支付完成后同步返回时也尝试处理订单，但如果异步回调失败，建议：
1. 检查 `payment_notify.php` 是否可访问
2. 查看支付平台的回调日志
3. 手动检查订单状态并处理

---

## 技术支持

如有其他问题，请查看：
- 服务器错误日志：`logs/php_errors.log`
- 支付平台文档
- 系统管理员

---

**最后更新：** 2026-01-28  
**版本：** v1.5.0
