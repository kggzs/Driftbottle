# VIP 会员系统

## 功能概述

VIP 会员系统为用户提供高级特权，包括更多的每日操作限制、专属标识等。

## 功能特性

### VIP 特权

- **更高的操作限制**：VIP 用户享有更多的每日扔瓶和捡瓶次数
- **专属标识**：VIP 用户在个人资料和漂流瓶上显示 VIP 标识
- **IP 地址保护**：VIP 用户的 IP 地址完全隐藏
- **积分购买**：使用积分购买 VIP 会员

### VIP 时长选项

- **1个月**：默认需要 100 积分
- **3个月**：默认需要 250 积分
- **6个月**：默认需要 450 积分
- **12个月**：默认需要 800 积分

> 注意：VIP 价格可在后台系统设置中配置

## 安装与配置

### 数据库初始化

如果是从头安装，VIP 相关表已包含在 `driftbottle.sql` 中。

如果是升级，执行以下脚本：

```bash
mysql -u driftbottle_user -p driftbottle < sql/vip_points_settings.sql
```

### 后台配置

1. 登录管理员后台
2. 访问"系统设置"页面
3. 切换到"VIP设置"选项卡
4. 配置各项 VIP 积分配置：
   - VIP会员1个月开通积分
   - VIP会员3个月开通积分
   - VIP会员6个月开通积分
   - VIP会员12个月开通积分

### 配置实时生效

所有配置修改后立即生效，无需重启服务器。系统会自动从数据库读取最新的配置值。

## 用户使用

### 购买 VIP

1. 访问个人中心页面
2. 在 VIP 区域选择购买时长
3. 确认积分足够
4. 点击"开通 VIP"按钮
5. 系统自动扣除积分并开通 VIP

### 续费 VIP

- 如果用户已有 VIP，可以选择续费
- 续费时长会累加到现有 VIP 到期时间
- 续费价格与购买价格相同

### VIP 到期

- VIP 到期后自动降级为普通用户
- 系统会显示 VIP 到期提示
- 用户可以重新购买 VIP

## 技术实现

### 数据库结构

**users 表相关字段：**
- `vip_expires_at`: VIP 到期时间（DATETIME）
- `points`: 用户积分（INT）

**system_settings 表配置项：**
- `vip_points_1month`: VIP 1个月所需积分
- `vip_points_3months`: VIP 3个月所需积分
- `vip_points_6months`: VIP 6个月所需积分
- `vip_points_12months`: VIP 12个月所需积分

### API 端点

#### 检查 VIP 状态

```
GET api.php?action=check_vip_status

返回:
{
    "success": true,
    "is_vip": true,
    "expires_at": "2025-12-31 23:59:59",
    "days_remaining": 30
}
```

#### 购买 VIP

```
POST api.php?action=purchase_vip
Content-Type: application/json

参数:
{
    "duration": 1  // 1, 3, 6, 12 个月
}

返回:
{
    "success": true,
    "message": "VIP开通成功",
    "vip_expires_at": "2025-12-31 23:59:59"
}
```

#### 获取 VIP 价格配置

```
GET api.php?action=get_vip_points_config

返回:
{
    "success": true,
    "prices": {
        "1": 100,
        "3": 250,
        "6": 450,
        "12": 800
    }
}
```

## 管理员功能

### 查看用户 VIP 状态

1. 访问"用户管理"页面
2. 点击用户详情
3. 查看 VIP 状态和到期时间

### 手动设置 VIP

管理员可以在用户详情页面手动设置用户的 VIP 到期时间。

### 统计 VIP 用户

在"数据统计"页面可以查看：
- VIP 用户总数
- 即将到期的 VIP 用户
- VIP 收入统计（积分消耗）

## 注意事项

1. **积分扣除**：购买 VIP 时会立即扣除相应积分
2. **时长累加**：续费时会将新时长累加到现有到期时间
3. **到期处理**：VIP 到期后自动降级，无需手动操作
4. **价格配置**：VIP 价格可在后台实时修改，修改后立即生效
5. **权限检查**：系统会在每次操作时检查 VIP 状态

## 故障排除

### VIP 购买失败

1. 检查用户积分是否足够
2. 检查数据库配置是否正确
3. 查看错误日志定位问题

### VIP 状态显示不正确

1. 检查 `vip_expires_at` 字段是否正确
2. 检查系统时间是否正确
3. 清除浏览器缓存

### VIP 特权未生效

1. 确认 VIP 未到期
2. 检查每日限制配置
3. 查看操作日志

## 更新日志

- **v1.0.1** (2025-04-20): 初始版本
  - 实现 VIP 购买和续费功能
  - VIP 特权标识和界面优化
  - VIP 到期自动检测和状态更新

- **v1.0.2** (2025-04-21): 配置优化
  - VIP 积分配置改为数据库存储
  - 支持后台实时配置 VIP 价格

