<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰”æ¼‚æµç“¶ - æ¼‚æµç“¶</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="assets/css/bootstrap/bootstrap.min.css">
    <link rel="stylesheet" href="assets/css/fontawesome/all.min.css">
    <link rel="stylesheet" href="assets/css/style.css">
    <script src="assets/js/bootstrap/bootstrap.bundle.min.js"></script>
    <script src="assets/js/utils.js"></script>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar navbar-expand">
        <div class="container">
            <a href="index.html" class="navbar-brand">æ¼‚æµç“¶</a>
            <div class="navbar-collapse">
                <ul class="navbar-nav">
                    <!-- åŠ¨æ€ç”Ÿæˆå¯¼èˆªé¡¹ -->
                </ul>
            </div>
        </div>
    </nav>
    
    <!-- ä¸»å†…å®¹ -->
    <div class="container">
        <div class="alert-container"></div>
        
        <div class="content">
            <div class="row">
                <div class="col-md-8 offset-md-2">
                    <!-- ç”¨æˆ·é™åˆ¶å’Œç§¯åˆ†ä¿¡æ¯ -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <div class="user-limits">
                                        <p class="mb-1"><i class="fas fa-gift text-success"></i> å…è´¹æ¬¡æ•°å‰©ä½™: <span id="freeThrowsRemaining">--</span>/<span id="totalFreeThrows">--</span> æ¬¡</p>
                                        <p class="mb-1" id="vipThrowBonus" style="display: none;"><i class="fas fa-crown text-warning"></i> <span class="text-warning">VIPç‰¹æƒï¼šæ¯å¤©é¢å¤–å…è´¹æ¬¡æ•°ï¼ˆ0ç‚¹åˆ·æ–°ï¼‰</span></p>
                                        <p class="mb-1" id="vipFreeThrows"><i class="fas fa-star text-warning"></i> ä¼šå‘˜æ¬¡æ•°å‰©ä½™: <span id="vipFreeThrowsRemaining">--</span>/<span id="totalVipFreeThrows">--</span> æ¬¡</p>
                                    </div>
                                </div>
                                <div class="col-md-4 text-end">
                                    <p class="mb-0"><i class="fas fa-coins text-warning"></i> æˆ‘çš„ç§¯åˆ†: <span id="userPoints">--</span></p>
                                    <small class="text-muted">æ¯ç“¶æ¶ˆè€—<span id="pointsPerBottle">1</span>ç§¯åˆ† (å…è´¹æ¬¡æ•°å†…ä¸æ¶ˆè€—)</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h2 class="text-center">æ‰”ä¸€ä¸ªæ¼‚æµç“¶</h2>
                        </div>
                        <div class="card-body">
                            <form id="throwBottleForm">
                                <div class="form-group mb-4">
                                    <label for="bottleContent" class="form-label">å†™ä¸‹ä½ æƒ³è¯´çš„è¯</label>
                                    <textarea class="form-control" id="bottleContent" name="bottleContent" rows="6" placeholder="åœ¨è¿™é‡Œå†™ä¸‹ä½ çš„å¿ƒæƒ…ã€ç§˜å¯†æˆ–æƒ³æ³•..."></textarea>
                                </div>
                                
                                <div class="form-group mb-4">
                                    <label for="mood" class="form-label">é€‰æ‹©ä½ çš„å¿ƒæƒ…</label>
                                    <select class="form-control" id="mood" name="mood">
                                        <option value="å¼€å¿ƒ">å¼€å¿ƒ ğŸ˜Š</option>
                                        <option value="éš¾è¿‡">éš¾è¿‡ ğŸ˜¢</option>
                                        <option value="å¹³é™">å¹³é™ ğŸ˜Œ</option>
                                        <option value="æ„¤æ€’">æ„¤æ€’ ğŸ˜¡</option>
                                        <option value="æœŸå¾…">æœŸå¾… ğŸ¤©</option>
                                        <option value="å¿§éƒ">å¿§éƒ ğŸ˜”</option>
                                        <option value="å…¶ä»–">å…¶ä»– ğŸ˜¶</option>
                                    </select>
                                </div>
                                
                                <div class="form-check mb-4">
                                    <input class="form-check-input" type="checkbox" id="isAnonymous" name="isAnonymous">
                                    <label class="form-check-label" for="isAnonymous">
                                        åŒ¿åå‘é€ï¼ˆéšè—ä½ çš„ç”¨æˆ·åï¼‰
                                    </label>
                                </div>
                                
                                <div class="form-check mb-4" id="locationDiv">
                                    <input class="form-check-input" type="checkbox" id="locationCheckbox" name="includeLocation" checked>
                                    <label class="form-check-label" for="locationCheckbox">
                                        <i class="fas fa-map-marker-alt"></i> æ˜¾ç¤ºåœ°ç†ä½ç½®ä¿¡æ¯ 
                                        <span class="text-muted small" id="locationHint"></span>
                                    </label>
                                    <div class="mt-2 small text-muted location-preview" id="locationPreview"></div>
                                </div>
                                
                                <div class="text-center">
                                    <button type="submit" class="btn btn-primary px-5" id="throwButton">
                                        <i class="fas fa-paper-plane"></i> æ‰”å‘å¤§æµ·
                                    </button>
                                </div>
                            </form>
                        </div>
                        <div class="card-footer">
                            <div class="text-center text-muted">
                                <p><small>ä½ çš„æ¼‚æµç“¶ä¼šè¢«éšæœºçš„ç”¨æˆ·æ¡èµ·ã€‚æç¤ºï¼šä¸è¦åœ¨æ¼‚æµç“¶ä¸­åŒ…å«ä½ çš„ä¸ªäººéšç§ä¿¡æ¯ã€‚</small></p>
                                <p><small>æ¯å¤©æœ‰10æ¬¡å…è´¹æ‰”ç“¶æœºä¼šï¼ŒVIPç”¨æˆ·é¢å¤–è·å¾—5æ¬¡å…è´¹æœºä¼šã€‚æ‰€æœ‰æ¬¡æ•°åœ¨æ¯å¤©0ç‚¹è‡ªåŠ¨åˆ·æ–°ï¼è¶…è¿‡å…è´¹æ¬¡æ•°åï¼Œæ¯æ¬¡æ‰”ç“¶æ¶ˆè€—1ç§¯åˆ†ã€‚</small></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- é¡µè„š -->
    <footer class="bg-dark text-light py-4 mt-5">
        <div class="container text-center">
            <p>æ¼‚æµç“¶ &copy; 2023 ç‰ˆæƒæ‰€æœ‰</p>
        </div>
    </footer>
    
    <script src="assets/js/app.js"></script>
    <script>
        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            // é˜²æ­¢è¡¨å•é‡å¤æäº¤çš„æ ‡è®°
            let isSubmitting = false;
            
            // é»˜è®¤é…ç½®å¸¸é‡ï¼ˆåç»­ä¼šä»APIè·å–ï¼‰
            window.POINTS_PER_BOTTLE = 1;
            window.DAILY_BOTTLE_LIMIT = 10;
            window.VIP_DAILY_BOTTLE_LIMIT = 15;
            
            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            checkAuth(function(isLoggedIn) {
                if (!isLoggedIn) {
                    window.location.href = 'login.html';
                    return;
                }
                
                // æ˜¾ç¤ºæ¯ç“¶æ¶ˆè€—çš„ç§¯åˆ†ï¼ˆä½¿ç”¨é»˜è®¤å€¼ï¼Œç¨åä¼šè¢«æ›´æ–°ï¼‰
                document.getElementById('pointsPerBottle').textContent = window.POINTS_PER_BOTTLE;
                
                // è·å–ç³»ç»Ÿé…ç½®å¸¸é‡
                fetch('api.php/get_system_config')
                .then(response => response.json())
                .then(config => {
                    if (config.success) {
                        // æ›´æ–°é…ç½®å¸¸é‡
                        window.POINTS_PER_BOTTLE = config.POINTS_PER_BOTTLE || window.POINTS_PER_BOTTLE;
                        window.DAILY_BOTTLE_LIMIT = config.DAILY_BOTTLE_LIMIT || window.DAILY_BOTTLE_LIMIT;
                        window.VIP_DAILY_BOTTLE_LIMIT = config.VIP_DAILY_BOTTLE_LIMIT || window.VIP_DAILY_BOTTLE_LIMIT;
                        
                        // æ˜¾ç¤ºæ¯ç“¶æ¶ˆè€—çš„ç§¯åˆ†
                        document.getElementById('pointsPerBottle').textContent = window.POINTS_PER_BOTTLE;
                    }
                })
                .catch(error => Logger.error('è·å–ç³»ç»Ÿé…ç½®å¤±è´¥:', error))
                .finally(() => {
                    // æ£€æŸ¥VIPçŠ¶æ€
                    checkVipStatus();
                    
                    // è·å–ç”¨æˆ·é™åˆ¶ä¿¡æ¯
                    getDailyLimits();
                    
                    // è·å–åœ°ç†ä½ç½®é¢„è§ˆ
                    getLocationPreview();
                });
                
                // è¡¨å•æäº¤äº‹ä»¶ - ä½¿ç”¨onclickæ›¿ä»£form submit
                const submitBtn = document.getElementById('throwButton');
                if (submitBtn) {
                    submitBtn.onclick = function(e) {
                        e.preventDefault();
                        
                        // é˜²æ­¢é‡å¤æäº¤
                        if (isSubmitting) {
                            Logger.log('é˜²æ­¢é‡å¤æäº¤');
                            return false;
                        }
                        
                        try {
                            const content = document.getElementById('bottleContent').value.trim();
                            const mood = document.getElementById('mood').value;
                            const isAnonymous = document.getElementById('isAnonymous').checked ? 1 : 0;
                            const includeLocation = document.getElementById('locationCheckbox').checked ? 1 : 0;
                            
                            if (content === '') {
                                showAlert('è¯·è¾“å…¥æ¼‚æµç“¶å†…å®¹', 'danger');
                                return false;
                            }
                            
                            // è®¾ç½®é˜²é‡å¤æäº¤æ ‡è®°
                            isSubmitting = true;
                            submitBtn.disabled = true;
                            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æ­£åœ¨æ‰”å‡º...';
                            
                            // æäº¤æ‰”ç“¶è¯·æ±‚
                            fetch('api.php/create_bottle', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ 
                                    content, 
                                    mood, 
                                    is_anonymous: isAnonymous,
                                    include_location: includeLocation
                                })
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    showAlert('æ¼‚æµç“¶å·²æˆåŠŸæ‰”å‡ºï¼', 'success');
                                    document.getElementById('bottleContent').value = '';
                                    document.getElementById('isAnonymous').checked = false;
                                    
                                    // æ›´æ–°ç§¯åˆ†å’Œé™åˆ¶ä¿¡æ¯
                                    updateUserPointsDisplay(data.is_free, data.points_deducted);
                                    getDailyLimits();
                                } else {
                                    showAlert(data.message, 'danger');
                                }
                            })
                            .catch(error => {
                                Logger.error('Error:', error);
                                showAlert('å‘ç”Ÿé”™è¯¯ï¼Œè¯·ç¨åå†è¯•', 'danger');
                            })
                            .finally(() => {
                                // æ— è®ºæˆåŠŸå¤±è´¥ï¼Œéƒ½é‡ç½®æäº¤çŠ¶æ€
                                submitBtn.disabled = false;
                                submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> æ‰”å‘å¤§æµ·';
                                isSubmitting = false;
                            });
                        } catch (e) {
                            Logger.error('Exception:', e);
                            showAlert('å‘ç”Ÿå¼‚å¸¸ï¼Œè¯·ç¨åå†è¯•', 'danger');
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> æ‰”å‘å¤§æµ·';
                            isSubmitting = false;
                        }
                        
                        return false; // é˜²æ­¢è¡¨å•é»˜è®¤æäº¤
                    };
                }
                
                // é˜»æ­¢è¡¨å•é»˜è®¤æäº¤
                const form = document.getElementById('throwBottleForm');
                if (form) {
                    form.onsubmit = function(e) {
                        e.preventDefault();
                        return false;
                    };
                }
            });
        });
        
        // è·å–ç”¨æˆ·æ¯æ—¥é™åˆ¶
        function getDailyLimits() {
            fetch('api.php/get_daily_limits')
            .then(response => response.json())
            .then(data => {
                Logger.log("æœåŠ¡å™¨è¿”å›çš„æ•°æ®:", data); // æ·»åŠ è°ƒè¯•ä¿¡æ¯
                
                if (data.success) {
                    // åŸºæœ¬é™åˆ¶ä¿¡æ¯ï¼Œç¡®ä¿ä¸æ˜¾ç¤ºè´Ÿæ•°
                    const freeThrowsRemaining = Math.max(0, data.free_throws_remaining || 0);
                    document.getElementById('freeThrowsRemaining').textContent = freeThrowsRemaining;
                    
                    // æ˜¾ç¤ºæ€»çš„å…è´¹æ¬¡æ•°é™åˆ¶ - ä½¿ç”¨å…¨å±€å˜é‡
                    document.getElementById('totalFreeThrows').textContent = window.DAILY_BOTTLE_LIMIT;
                    
                    // è·å–æœ€æ–°ç§¯åˆ†
                    fetch('api.php/user_info')
                    .then(response => response.json())
                    .then(userData => {
                        if (userData.success && userData.user) {
                            // æ›´æ–°å…¨å±€ç”¨æˆ·ä¿¡æ¯
                            if (!window.userInfo) window.userInfo = {};
                            window.userInfo.points = userData.user.points;
                            document.getElementById('userPoints').textContent = userData.user.points;
                        }
                    })
                    .catch(error => Logger.error('Error:', error));
                    
                    // æ›´æ–°VIPç›¸å…³ä¿¡æ¯
                    if (data.is_vip) {
                        Logger.log("VIPç”¨æˆ·ï¼Œå°è¯•æ˜¾ç¤ºVIPç‰¹æƒ"); // è°ƒè¯•ä¿¡æ¯
                        
                        // æ˜¾ç¤ºVIPç‰¹æƒä¿¡æ¯
                        const vipThrowBonus = document.getElementById('vipThrowBonus');
                        if (vipThrowBonus) {
                            vipThrowBonus.style.display = 'block';
                        }
                        
                        // æ˜¾ç¤ºVIPä¸“å±æ¬¡æ•°
                        const vipFreeThrows = document.getElementById('vipFreeThrows');
                        if (vipFreeThrows) {
                            vipFreeThrows.style.display = 'block';
                            // ä½¿ç”¨åç«¯è¿”å›çš„VIPä¸“å±å‰©ä½™æ¬¡æ•°
                            const vipFreeThrowsRemaining = Math.max(0, data.vip_free_throws_remaining || 0);
                            document.getElementById('vipFreeThrowsRemaining').textContent = vipFreeThrowsRemaining;
                            
                            // æ˜¾ç¤ºæ€»çš„VIPä¸“å±æ¬¡æ•° - ä½¿ç”¨å…¨å±€å˜é‡
                            const vipExtraLimit = window.VIP_DAILY_BOTTLE_LIMIT - window.DAILY_BOTTLE_LIMIT;
                            document.getElementById('totalVipFreeThrows').textContent = vipExtraLimit;
                            
                            Logger.log("VIPä¸“å±æ¬¡æ•°:", vipFreeThrowsRemaining); // è°ƒè¯•ä¿¡æ¯
                        }
                        
                        // æ›´æ–°é¡µè„šä¿¡æ¯
                        const limitInfo = document.querySelector('.card-footer p:last-child small');
                        if (limitInfo) {
                            limitInfo.textContent = `VIPç‰¹æƒï¼šæ¯å¤©æœ‰${window.VIP_DAILY_BOTTLE_LIMIT}æ¬¡å…è´¹æ‰”ç“¶æœºä¼šï¼ŒåŒ…æ‹¬${window.VIP_DAILY_BOTTLE_LIMIT - window.DAILY_BOTTLE_LIMIT}æ¬¡ä¸“å±ä¼šå‘˜æ¬¡æ•°ã€‚`;
                        }
                    } else {
                        // éVIPç”¨æˆ·éšè—VIPç›¸å…³ä¿¡æ¯
                        const vipThrowBonus = document.getElementById('vipThrowBonus');
                        if (vipThrowBonus) {
                            vipThrowBonus.style.display = 'none';
                        }
                        const vipFreeThrows = document.getElementById('vipFreeThrows');
                        if (vipFreeThrows) {
                            vipFreeThrows.style.display = 'none';
                        }
                    }
                    
                    // å½“å…è´¹æ¬¡æ•°ç”¨å®Œæ—¶ï¼Œæé†’ç”¨æˆ·å°†æ¶ˆè€—ç§¯åˆ†
                    const pointsWarning = document.querySelector('.col-md-4 small.text-muted');
                    if (pointsWarning) {
                        if (freeThrowsRemaining <= 0 && (!data.is_vip || data.vip_free_throws_remaining <= 0)) {
                            pointsWarning.innerHTML = '<span class="text-danger"><i class="fas fa-exclamation-circle"></i> å…è´¹æ¬¡æ•°å·²ç”¨å®Œï¼Œå°†æ¶ˆè€—ç§¯åˆ†</span>';
                        } else {
                            pointsWarning.textContent = 'æ¯ç“¶æ¶ˆè€—' + window.POINTS_PER_BOTTLE + 'ç§¯åˆ† (å…è´¹æ¬¡æ•°å†…ä¸æ¶ˆè€—)';
                        }
                    }
                }
            })
            .catch(error => Logger.error('Error:', error));
        }
        
        // æ›´æ–°ç§¯åˆ†æ˜¾ç¤º
        function updateUserPointsDisplay(isFree, pointsDeducted) {
            if (window.userInfo) {
                if (!isFree) {
                    window.userInfo.points -= pointsDeducted;
                    document.getElementById('userPoints').textContent = window.userInfo.points;
                }
            }
        }
        
        // æ›´æ–°æ‰”ç“¶æŒ‰é’®çŠ¶æ€
        function updateThrowButton(disable) {
            const throwButton = document.getElementById('throwButton');
            if (disable) {
                throwButton.disabled = true;
                throwButton.innerHTML = '<i class="fas fa-ban"></i> ä»Šæ—¥å·²è¾¾ä¸Šé™';
            } else {
                throwButton.disabled = false;
                throwButton.innerHTML = '<i class="fas fa-paper-plane"></i> æ‰”å‘å¤§æµ·';
            }
        }
        
        // æ£€æŸ¥VIPçŠ¶æ€
        function checkVipStatus() {
            fetch('api.php/check_vip_status')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // ä¿å­˜VIPçŠ¶æ€åˆ°å…¨å±€å¯¹è±¡
                    if (!window.userInfo) window.userInfo = {};
                    window.userInfo.is_vip = data.is_vip;
                    window.userInfo.vip_level = data.vip_level;
                    window.userInfo.vip_expire_date = data.vip_expire_date;
                    
                    // å¦‚æœæ˜¯VIPç”¨æˆ·ï¼Œæ›´æ–°UIæ˜¾ç¤º
                    if (data.is_vip) {
                        // æ›´æ–°VIPç‰¹æƒä¿¡æ¯
                        const vipThrowBonus = document.getElementById('vipThrowBonus');
                        if (vipThrowBonus) {
                            vipThrowBonus.style.display = 'block';
                        }
                        
                        // æ›´æ–°VIPä¸“å±æ¬¡æ•°
                        const vipFreeThrows = document.getElementById('vipFreeThrows');
                        if (vipFreeThrows) {
                            vipFreeThrows.style.display = 'block';
                        }
                        
                        // æ›´æ–°é¡µè„šä¿¡æ¯
                        const limitInfo = document.querySelector('.card-footer p:last-child small');
                        if (limitInfo) {
                            limitInfo.textContent = `VIPç‰¹æƒï¼šæ¯å¤©æœ‰${window.VIP_DAILY_BOTTLE_LIMIT}æ¬¡å…è´¹æ‰”ç“¶æœºä¼šï¼ŒåŒ…æ‹¬${window.VIP_DAILY_BOTTLE_LIMIT - window.DAILY_BOTTLE_LIMIT}æ¬¡ä¸“å±ä¼šå‘˜æ¬¡æ•°ã€‚`;
                        }
                        
                        // æ›´æ–°åœ°ç†ä½ç½®ä¿¡æ¯å‹¾é€‰æ¡†
                        const locationCheckbox = document.getElementById('locationCheckbox');
                        if (locationCheckbox) {
                            locationCheckbox.disabled = false;
                            locationCheckbox.checked = true;
                            const locationHint = document.getElementById('locationHint');
                            if (locationHint) {
                                locationHint.textContent = '(VIPå¯å–æ¶ˆ)';
                            }
                        }
                    } else {
                        // éVIPç”¨æˆ·ï¼Œå¼ºåˆ¶å¯ç”¨åœ°ç†ä½ç½®ä¿¡æ¯
                        const locationCheckbox = document.getElementById('locationCheckbox');
                        if (locationCheckbox) {
                            locationCheckbox.disabled = true;
                            locationCheckbox.checked = true;
                            const locationHint = document.getElementById('locationHint');
                            if (locationHint) {
                                locationHint.textContent = '(å¿…é€‰)';
                            }
                        }
                    }
                }
            })
            .catch(error => Logger.error('Error:', error));
        }
        
        // è·å–åœ°ç†ä½ç½®é¢„è§ˆ
        async function getLocationPreview() {
            try {
                const response = await fetch('api.php/get_location_preview');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.message || 'è·å–ä½ç½®ä¿¡æ¯å¤±è´¥');
                }
                
                const locationPreview = document.getElementById('locationPreview');
                let previewText = `<i class="fas fa-map-marker-alt text-danger"></i> ${data.location}`;
                
                if (data.ip_address) {
                    const isVip = window.userInfo && window.userInfo.is_vip;
                    if (isVip) {
                        previewText += `<br><i class="fas fa-globe text-primary"></i> IP: ${data.ip_address}`;
                    } else {
                        // å¯¹éVIPç”¨æˆ·éšè—éƒ¨åˆ†IP
                        const maskedIp = data.ip_address.replace(/(\d+)\.(\d+)\.(\d+)\.(\d+)/, '$1.$2.**.***');
                        previewText += `<br><i class="fas fa-globe text-primary"></i> IP: ${maskedIp}`;
                    }
                }
                
                locationPreview.innerHTML = previewText;
            } catch (error) {
                Logger.error('è·å–ä½ç½®ä¿¡æ¯å¤±è´¥:', error);
                const locationPreview = document.getElementById('locationPreview');
                locationPreview.innerHTML = `
                    <p class="error">è·å–ä½ç½®ä¿¡æ¯å¤±è´¥</p>
                    <p class="error-detail">${error.message}</p>
                `;
            }
        }
    </script>
</body>
</html>