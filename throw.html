<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰”æ¼‚æµç“¶ - æ¼‚æµç“¶</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="assets/css/bootstrap/bootstrap.min.css">
    <link rel="stylesheet" href="assets/css/fontawesome/all.min.css">
    <link rel="stylesheet" href="assets/css/style.css">
    <script src="assets/js/bootstrap/bootstrap.bundle.min.js"></script>
    <script src="assets/js/utils.js"></script>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar navbar-expand">
        <div class="container">
            <a href="index.html" class="navbar-brand">æ¼‚æµç“¶</a>
            <div class="navbar-collapse">
                <ul class="navbar-nav">
                    <!-- åŠ¨æ€ç”Ÿæˆå¯¼èˆªé¡¹ -->
                </ul>
            </div>
        </div>
    </nav>
    
    <!-- ä¸»å†…å®¹ -->
    <div class="container">
        <div class="alert-container"></div>
        
        <div class="content">
            <div class="row">
                <div class="col-md-8 offset-md-2">
                    <!-- ç”¨æˆ·é™åˆ¶å’Œç§¯åˆ†ä¿¡æ¯ -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <div class="user-limits">
                                        <p class="mb-1"><i class="fas fa-gift text-success"></i> å…è´¹æ¬¡æ•°å‰©ä½™: <span id="freeThrowsRemaining">--</span>/<span id="totalFreeThrows">--</span> æ¬¡</p>
                                        <p class="mb-1" id="vipThrowBonus" style="display: none;"><i class="fas fa-crown text-warning"></i> <span class="text-warning">VIPç‰¹æƒï¼šæ¯å¤©é¢å¤–å…è´¹æ¬¡æ•°ï¼ˆ0ç‚¹åˆ·æ–°ï¼‰</span></p>
                                        <p class="mb-1" id="vipFreeThrows"><i class="fas fa-star text-warning"></i> ä¼šå‘˜æ¬¡æ•°å‰©ä½™: <span id="vipFreeThrowsRemaining">--</span>/<span id="totalVipFreeThrows">--</span> æ¬¡</p>
                                    </div>
                                </div>
                                <div class="col-md-4 text-end">
                                    <p class="mb-0"><i class="fas fa-coins text-warning"></i> æˆ‘çš„ç§¯åˆ†: <span id="userPoints">--</span></p>
                                    <small class="text-muted">æ¯ç“¶æ¶ˆè€—<span id="pointsPerBottle">1</span>ç§¯åˆ† (å…è´¹æ¬¡æ•°å†…ä¸æ¶ˆè€—)</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h2 class="text-center">æ‰”ä¸€ä¸ªæ¼‚æµç“¶</h2>
                        </div>
                        <div class="card-body">
                            <form id="throwBottleForm">
                                <!-- æ¼‚æµç“¶ç±»å‹é€‰æ‹© -->
                                <div class="form-group mb-4">
                                    <label class="form-label">é€‰æ‹©æ¼‚æµç“¶ç±»å‹</label>
                                    <div class="btn-group w-100" role="group">
                                        <input type="radio" class="btn-check" name="bottleType" id="bottleTypeText" value="text" checked>
                                        <label class="btn btn-outline-primary" for="bottleTypeText">
                                            <i class="fas fa-pen"></i> æ–‡å­—æ¼‚æµç“¶
                                        </label>
                                        
                                        <input type="radio" class="btn-check" name="bottleType" id="bottleTypeVoice" value="voice">
                                        <label class="btn btn-outline-primary" for="bottleTypeVoice">
                                            <i class="fas fa-microphone"></i> è¯­éŸ³æ¼‚æµç“¶
                                        </label>
                                    </div>
                                </div>
                                
                                <!-- æ–‡å­—å†…å®¹åŒºåŸŸ -->
                                <div class="form-group mb-4" id="textContentArea">
                                    <label for="bottleContent" class="form-label">å†™ä¸‹ä½ æƒ³è¯´çš„è¯</label>
                                    <textarea class="form-control" id="bottleContent" name="bottleContent" rows="6" placeholder="åœ¨è¿™é‡Œå†™ä¸‹ä½ çš„å¿ƒæƒ…ã€ç§˜å¯†æˆ–æƒ³æ³•..."></textarea>
                                </div>
                                
                                <!-- è¯­éŸ³å½•åˆ¶åŒºåŸŸ -->
                                <div class="form-group mb-4" id="voiceContentArea" style="display: none;">
                                    <label class="form-label">å½•åˆ¶ä½ çš„è¯­éŸ³</label>
                                    <div class="voice-recorder border rounded p-4 text-center">
                                        <div id="recordingStatus" class="mb-3">
                                            <i class="fas fa-microphone fa-3x text-muted"></i>
                                            <p class="mt-2 text-muted">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹å½•éŸ³</p>
                                        </div>
                                        <div id="recordingControls" class="mb-3">
                                            <button type="button" class="btn btn-danger btn-lg" id="startRecordBtn">
                                                <i class="fas fa-circle"></i> å¼€å§‹å½•éŸ³
                                            </button>
                                            <button type="button" class="btn btn-warning btn-lg" id="stopRecordBtn" style="display: none;">
                                                <i class="fas fa-stop"></i> åœæ­¢å½•éŸ³
                                            </button>
                                            <button type="button" class="btn btn-secondary btn-lg" id="playRecordBtn" style="display: none;">
                                                <i class="fas fa-play"></i> æ’­æ”¾
                                            </button>
                                            <button type="button" class="btn btn-secondary btn-lg" id="deleteRecordBtn" style="display: none;">
                                                <i class="fas fa-trash"></i> é‡æ–°å½•åˆ¶
                                            </button>
                                        </div>
                                        <div id="recordingTimer" class="mb-2" style="display: none;">
                                            <span class="badge bg-danger fs-6">å½•éŸ³æ—¶é•¿: <span id="timerDisplay">00:00</span></span>
                                        </div>
                                        <audio id="audioPreview" controls style="display: none; width: 100%;" class="mt-3"></audio>
                                        <input type="hidden" id="audioBlob" name="audioBlob">
                                    </div>
                                </div>
                                
                                <div class="form-group mb-4">
                                    <label for="mood" class="form-label">é€‰æ‹©ä½ çš„å¿ƒæƒ…</label>
                                    <select class="form-control" id="mood" name="mood">
                                        <option value="å¼€å¿ƒ">å¼€å¿ƒ ğŸ˜Š</option>
                                        <option value="éš¾è¿‡">éš¾è¿‡ ğŸ˜¢</option>
                                        <option value="å¹³é™">å¹³é™ ğŸ˜Œ</option>
                                        <option value="æ„¤æ€’">æ„¤æ€’ ğŸ˜¡</option>
                                        <option value="æœŸå¾…">æœŸå¾… ğŸ¤©</option>
                                        <option value="å¿§éƒ">å¿§éƒ ğŸ˜”</option>
                                        <option value="å…¶ä»–">å…¶ä»– ğŸ˜¶</option>
                                    </select>
                                </div>
                                
                                <div class="form-check mb-4">
                                    <input class="form-check-input" type="checkbox" id="isAnonymous" name="isAnonymous">
                                    <label class="form-check-label" for="isAnonymous">
                                        åŒ¿åå‘é€ï¼ˆéšè—ä½ çš„ç”¨æˆ·åï¼‰
                                    </label>
                                </div>
                                
                                <div class="form-check mb-4" id="locationDiv">
                                    <input class="form-check-input" type="checkbox" id="locationCheckbox" name="includeLocation" checked>
                                    <label class="form-check-label" for="locationCheckbox">
                                        <i class="fas fa-map-marker-alt"></i> æ˜¾ç¤ºåœ°ç†ä½ç½®ä¿¡æ¯ 
                                        <span class="text-muted small" id="locationHint"></span>
                                    </label>
                                    <div class="mt-2 small text-muted location-preview" id="locationPreview"></div>
                                </div>
                                
                                <div class="text-center">
                                    <button type="submit" class="btn btn-primary px-5" id="throwButton">
                                        <i class="fas fa-paper-plane"></i> æ‰”å‘å¤§æµ·
                                    </button>
                                </div>
                            </form>
                        </div>
                        <div class="card-footer">
                            <div class="text-center text-muted">
                                <p><small>ä½ çš„æ¼‚æµç“¶ä¼šè¢«éšæœºçš„ç”¨æˆ·æ¡èµ·ã€‚æç¤ºï¼šä¸è¦åœ¨æ¼‚æµç“¶ä¸­åŒ…å«ä½ çš„ä¸ªäººéšç§ä¿¡æ¯ã€‚</small></p>
                                <p><small>æ¯å¤©æœ‰10æ¬¡å…è´¹æ‰”ç“¶æœºä¼šï¼ŒVIPç”¨æˆ·é¢å¤–è·å¾—5æ¬¡å…è´¹æœºä¼šã€‚æ‰€æœ‰æ¬¡æ•°åœ¨æ¯å¤©0ç‚¹è‡ªåŠ¨åˆ·æ–°ï¼è¶…è¿‡å…è´¹æ¬¡æ•°åï¼Œæ¯æ¬¡æ‰”ç“¶æ¶ˆè€—1ç§¯åˆ†ã€‚</small></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- é¡µè„š -->
    <footer class="bg-dark text-light py-4 mt-5">
        <div class="container text-center">
            <p class="mb-2">æ¼‚æµç“¶ &copy; 2023 ç‰ˆæƒæ‰€æœ‰</p>
        </div>
    </footer>
    
    <script>
        // æ ‡è®°é¡µé¢å·²æœ‰è‡ªå·±çš„åˆå§‹åŒ–é€»è¾‘ï¼Œé¿å… app.js é‡å¤åˆå§‹åŒ–
        window.pageHasCustomInit = true;
    </script>
    <script src="assets/js/app.js"></script>
    <script>
        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', async function() {
            // é˜²æ­¢è¡¨å•é‡å¤æäº¤çš„æ ‡è®°
            let isSubmitting = false;
            
            // é»˜è®¤é…ç½®å¸¸é‡ï¼ˆåç»­ä¼šä»APIè·å–ï¼‰
            window.POINTS_PER_BOTTLE = 1;
            window.DAILY_BOTTLE_LIMIT = 10;
            window.VIP_DAILY_BOTTLE_LIMIT = 15;
            
            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            try {
                const authResponse = await fetch('api.php?action=check_auth');
                const authData = await authResponse.json();
                
                if (!authData.success || !authData.loggedIn) {
                    window.location.href = 'login.html';
                    return;
                }
                
                // ä¿å­˜ç”¨æˆ·ä¿¡æ¯
                if (!window.userInfo) window.userInfo = {};
                window.userInfo.id = authData.user_id;
                window.userInfo.username = authData.username;
                window.userInfo.points = authData.points || 0;
                
                // æ˜¾ç¤ºæ¯ç“¶æ¶ˆè€—çš„ç§¯åˆ†ï¼ˆä½¿ç”¨é»˜è®¤å€¼ï¼Œç¨åä¼šè¢«æ›´æ–°ï¼‰
                document.getElementById('pointsPerBottle').textContent = window.POINTS_PER_BOTTLE;
                document.getElementById('userPoints').textContent = window.userInfo.points;
                
                // å¹¶è¡ŒåŠ è½½å…³é”®æ•°æ®ï¼ˆåœ°ç†ä½ç½®å»¶è¿ŸåŠ è½½ï¼‰
                const [configRes, limitsRes, vipRes] = await Promise.allSettled([
                    fetch('api.php?action=get_system_config'),
                    fetch('api.php?action=get_daily_limits'),
                    fetch('api.php?action=check_vip_status')
                ]);
                
                // åœ°ç†ä½ç½®ä¿¡æ¯å»¶è¿ŸåŠ è½½ï¼ˆéå…³é”®ä¿¡æ¯ï¼‰
                const locationResPromise = fetch('api.php?action=get_location_preview').catch(err => {
                    Logger.error('åœ°ç†ä½ç½®æŸ¥è¯¢å¤±è´¥:', err);
                    return { ok: false };
                });
                
                // å¤„ç†ç³»ç»Ÿé…ç½®
                if (configRes.status === 'fulfilled') {
                    try {
                        const config = await configRes.value.json();
                        if (config.success) {
                            window.POINTS_PER_BOTTLE = config.POINTS_PER_BOTTLE || window.POINTS_PER_BOTTLE;
                            window.DAILY_BOTTLE_LIMIT = config.DAILY_BOTTLE_LIMIT || window.DAILY_BOTTLE_LIMIT;
                            window.VIP_DAILY_BOTTLE_LIMIT = config.VIP_DAILY_BOTTLE_LIMIT || window.VIP_DAILY_BOTTLE_LIMIT;
                            document.getElementById('pointsPerBottle').textContent = window.POINTS_PER_BOTTLE;
                        }
                    } catch (e) {
                        Logger.error('è§£æç³»ç»Ÿé…ç½®å¤±è´¥:', e);
                    }
                }
                
                // å¤„ç†æ¯æ—¥é™åˆ¶å’Œç”¨æˆ·ä¿¡æ¯
                if (limitsRes.status === 'fulfilled') {
                    try {
                        const limitsData = await limitsRes.value.json();
                        if (limitsData.success) {
                            updateDailyLimitsDisplay(limitsData);
                        }
                    } catch (e) {
                        Logger.error('è§£ææ¯æ—¥é™åˆ¶å¤±è´¥:', e);
                    }
                }
                
                // å¤„ç†VIPçŠ¶æ€
                if (vipRes.status === 'fulfilled') {
                    try {
                        const vipData = await vipRes.value.json();
                        if (vipData.success) {
                            updateVipStatusDisplay(vipData);
                        }
                    } catch (e) {
                        Logger.error('è§£æVIPçŠ¶æ€å¤±è´¥:', e);
                    }
                }
                
                // å¤„ç†åœ°ç†ä½ç½®é¢„è§ˆï¼ˆå»¶è¿ŸåŠ è½½ï¼‰
                locationResPromise.then(async (locationRes) => {
                    if (locationRes.ok) {
                        try {
                            const locationData = await locationRes.json();
                            if (locationData.success) {
                                updateLocationPreview(locationData);
                            }
                        } catch (e) {
                            Logger.error('è§£æåœ°ç†ä½ç½®å¤±è´¥:', e);
                        }
                    }
                }).catch(err => {
                    Logger.error('åœ°ç†ä½ç½®æŸ¥è¯¢å¤±è´¥:', err);
                });
                
                // è¡¨å•æäº¤äº‹ä»¶ - ä½¿ç”¨onclickæ›¿ä»£form submit
                const submitBtn = document.getElementById('throwButton');
                if (submitBtn) {
                    submitBtn.onclick = async function(e) {
                        e.preventDefault();
                        
                        // é˜²æ­¢é‡å¤æäº¤
                        if (isSubmitting) {
                            Logger.log('é˜²æ­¢é‡å¤æäº¤');
                            return false;
                        }
                        
                        try {
                            const bottleType = document.querySelector('input[name="bottleType"]:checked').value;
                            const mood = document.getElementById('mood').value;
                            const isAnonymous = document.getElementById('isAnonymous').checked ? 1 : 0;
                            const includeLocation = document.getElementById('locationCheckbox').checked ? 1 : 0;
                            
                            // éªŒè¯å†…å®¹
                            if (bottleType === 'text') {
                                const content = document.getElementById('bottleContent').value.trim();
                                if (content === '') {
                                    showAlert('è¯·è¾“å…¥æ¼‚æµç“¶å†…å®¹', 'danger');
                                    return false;
                                }
                            } else if (bottleType === 'voice') {
                                const audioBlob = document.getElementById('audioBlob').value;
                                if (!audioBlob) {
                                    showAlert('è¯·å…ˆå½•åˆ¶è¯­éŸ³', 'danger');
                                    return false;
                                }
                            }
                            
                            // è®¾ç½®é˜²é‡å¤æäº¤æ ‡è®°
                            isSubmitting = true;
                            submitBtn.disabled = true;
                            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æ­£åœ¨æ‰”å‡º...';
                            
                            // å‡†å¤‡æäº¤æ•°æ®
                            let submitData = {
                                bottle_type: bottleType,
                                mood: mood,
                                is_anonymous: isAnonymous,
                                include_location: includeLocation
                            };
                            
                            if (bottleType === 'text') {
                                submitData.content = document.getElementById('bottleContent').value.trim();
                            } else if (bottleType === 'voice') {
                                // è¯­éŸ³æ¼‚æµç“¶éœ€è¦å…ˆä¸Šä¼ éŸ³é¢‘æ–‡ä»¶
                                const audioBlobData = document.getElementById('audioBlob').value;
                                if (!audioBlobData) {
                                    showAlert('è¯·å…ˆå½•åˆ¶è¯­éŸ³', 'danger');
                                    submitBtn.disabled = false;
                                    submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> æ‰”å‘å¤§æµ·';
                                    isSubmitting = false;
                                    return false;
                                }
                                
                                // å…ˆä¸Šä¼ éŸ³é¢‘æ–‡ä»¶
                                try {
                                    const audioBlob = dataURLtoBlob(audioBlobData);
                                    const formData = new FormData();
                                    formData.append('audio', audioBlob, 'voice_' + Date.now() + '.webm');
                                    
                                    const uploadResponse = await fetch('api.php?action=upload_audio', {
                                        method: 'POST',
                                        body: formData
                                    });
                                    
                                    const uploadResult = await uploadResponse.json();
                                    if (!uploadResult.success) {
                                        throw new Error(uploadResult.message || 'éŸ³é¢‘ä¸Šä¼ å¤±è´¥');
                                    }
                                    
                                    submitData.audio_file = uploadResult.audio_file;
                                    submitData.audio_duration = uploadResult.audio_duration || 0;
                                } catch (uploadError) {
                                    Logger.error('éŸ³é¢‘ä¸Šä¼ é”™è¯¯:', uploadError);
                                    showAlert('éŸ³é¢‘ä¸Šä¼ å¤±è´¥ï¼š' + uploadError.message, 'danger');
                                    submitBtn.disabled = false;
                                    submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> æ‰”å‘å¤§æµ·';
                                    isSubmitting = false;
                                    return false;
                                }
                            }
                            
                            // æäº¤æ‰”ç“¶è¯·æ±‚
                            const response = await fetch('api.php?action=create_bottle', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(submitData)
                            });
                            
                            // æ£€æŸ¥å“åº”çŠ¶æ€
                            if (!response.ok) {
                                throw new Error(`HTTPé”™è¯¯: ${response.status} ${response.statusText}`);
                            }
                            
                            // æ£€æŸ¥å“åº”å†…å®¹ç±»å‹
                            const contentType = response.headers.get('content-type');
                            if (!contentType || !contentType.includes('application/json')) {
                                const text = await response.text();
                                Logger.error('éJSONå“åº”:', text);
                                throw new Error('æœåŠ¡å™¨è¿”å›äº†éJSONæ ¼å¼çš„å“åº”');
                            }
                            
                            // å°è¯•è§£æJSON
                            const text = await response.text();
                            let data;
                            try {
                                data = JSON.parse(text);
                            } catch (parseError) {
                                Logger.error('JSONè§£æé”™è¯¯:', parseError);
                                Logger.error('åŸå§‹å“åº”:', text);
                                throw new Error('æœåŠ¡å™¨è¿”å›çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®: ' + parseError.message);
                            }
                            
                            if (data.success) {
                                showAlert('æ¼‚æµç“¶å·²æˆåŠŸæ‰”å‡ºï¼', 'success');
                                document.getElementById('bottleContent').value = '';
                                document.getElementById('isAnonymous').checked = false;
                                
                                // é‡ç½®è¯­éŸ³å½•åˆ¶
                                if (typeof resetVoiceRecorder === 'function') {
                                    resetVoiceRecorder();
                                }
                                
                                // æ›´æ–°ç§¯åˆ†å’Œé™åˆ¶ä¿¡æ¯
                                updateUserPointsDisplay(data.is_free, data.points_deducted);
                                getDailyLimits();
                            } else {
                                showAlert(data.message || 'æ‰”æ¼‚æµç“¶å¤±è´¥ï¼Œè¯·ç¨åå†è¯•', 'danger');
                            }
                        } catch (e) {
                            Logger.error('Exception:', e);
                            showAlert('å‘ç”Ÿå¼‚å¸¸ï¼Œè¯·ç¨åå†è¯•', 'danger');
                        } finally {
                            // æ— è®ºæˆåŠŸå¤±è´¥ï¼Œéƒ½é‡ç½®æäº¤çŠ¶æ€
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> æ‰”å‘å¤§æµ·';
                            isSubmitting = false;
                        }
                        
                        return false; // é˜²æ­¢è¡¨å•é»˜è®¤æäº¤
                    };
                }
                
                // é˜»æ­¢è¡¨å•é»˜è®¤æäº¤
                const form = document.getElementById('throwBottleForm');
                if (form) {
                    form.onsubmit = function(e) {
                        e.preventDefault();
                        return false;
                    };
                }
                
                // åˆå§‹åŒ–è¯­éŸ³å½•åˆ¶ç›¸å…³åŠŸèƒ½
                initVoiceRecorderControls();
                initBottleTypeSwitcher();
                
                // æ‰‹åŠ¨æ›´æ–°å¯¼èˆªæ ï¼Œé¿å… app.js é‡å¤è°ƒç”¨ check_auth
                updateNavBarManually();
            } catch (error) {
                Logger.error('é¡µé¢åˆå§‹åŒ–é”™è¯¯:', error);
                showAlert('é¡µé¢åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•', 'danger');
            }
        });
        
        // æ‰‹åŠ¨æ›´æ–°å¯¼èˆªæ ï¼ˆå¤ç”¨å·²æœ‰çš„ç”¨æˆ·ä¿¡æ¯ï¼‰
        function updateNavBarManually() {
            const navbarContainer = document.querySelector('.navbar-nav');
            if (!navbarContainer) return;
            
            if (window.userInfo && window.userInfo.id) {
                // å·²ç™»å½•çŠ¶æ€
                navbarContainer.innerHTML = `
                    <li class="nav-item"><a href="index.html" class="nav-link">é¦–é¡µ</a></li>
                    <li class="nav-item"><a href="throw.html" class="nav-link">æ‰”æ¼‚æµç“¶</a></li>
                    <li class="nav-item"><a href="pick.html" class="nav-link">æ¡æ¼‚æµç“¶</a></li>
                    <li class="nav-item"><a href="profile.html" class="nav-link">ä¸ªäººä¸­å¿ƒ</a></li>
                    <li class="nav-item"><a href="#" class="nav-link logout-btn">é€€å‡ºç™»å½•</a></li>
                `;
                
                // ç»‘å®šé€€å‡ºç™»å½•äº‹ä»¶
                const logoutBtn = document.querySelector('.logout-btn');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', async (e) => {
                        e.preventDefault();
                        try {
                            const response = await fetch('api.php?action=logout');
                            const data = await response.json();
                            if (data.success) {
                                window.location.href = 'login.html';
                            }
                        } catch (error) {
                            Logger.error('é€€å‡ºç™»å½•å¤±è´¥:', error);
                        }
                    });
                }
            } else {
                // æœªç™»å½•çŠ¶æ€
                navbarContainer.innerHTML = `
                    <li class="nav-item"><a href="index.html" class="nav-link">é¦–é¡µ</a></li>
                    <li class="nav-item"><a href="login.html" class="nav-link">ç™»å½•</a></li>
                    <li class="nav-item"><a href="register.html" class="nav-link">æ³¨å†Œ</a></li>
                `;
            }
        }
        
        // åˆå§‹åŒ–è¯­éŸ³å½•åˆ¶æ§åˆ¶
        function initVoiceRecorderControls() {
            const startBtn = document.getElementById('startRecordBtn');
            const stopBtn = document.getElementById('stopRecordBtn');
            const playBtn = document.getElementById('playRecordBtn');
            const deleteBtn = document.getElementById('deleteRecordBtn');
            
            if (startBtn) {
                startBtn.addEventListener('click', async function() {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        mediaRecorder = new MediaRecorder(stream);
                        audioChunks = [];
                        
                        mediaRecorder.ondataavailable = function(event) {
                            audioChunks.push(event.data);
                        };
                        
                        mediaRecorder.onstop = function() {
                            audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                            const audioUrl = URL.createObjectURL(audioBlob);
                            const audioPreview = document.getElementById('audioPreview');
                            audioPreview.src = audioUrl;
                            audioPreview.style.display = 'block';
                            
                            const reader = new FileReader();
                            reader.onloadend = function() {
                                document.getElementById('audioBlob').value = reader.result;
                            };
                            reader.readAsDataURL(audioBlob);
                            
                            stream.getTracks().forEach(track => track.stop());
                        };
                        
                        mediaRecorder.start();
                        recordingStartTime = Date.now();
                        
                        document.getElementById('startRecordBtn').style.display = 'none';
                        document.getElementById('stopRecordBtn').style.display = 'inline-block';
                        document.getElementById('recordingStatus').innerHTML = '<i class="fas fa-microphone fa-3x text-danger"></i><p class="mt-2 text-danger">æ­£åœ¨å½•éŸ³ä¸­...</p>';
                        document.getElementById('recordingTimer').style.display = 'block';
                        
                        recordingTimer = setInterval(updateTimer, 1000);
                    } catch (error) {
                        Logger.error('å½•éŸ³å¤±è´¥:', error);
                        showAlert('æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æƒé™è®¾ç½®', 'danger');
                    }
                });
            }
            
            if (stopBtn) {
                stopBtn.addEventListener('click', function() {
                    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                        mediaRecorder.stop();
                        clearInterval(recordingTimer);
                        
                        document.getElementById('startRecordBtn').style.display = 'inline-block';
                        document.getElementById('stopRecordBtn').style.display = 'none';
                        document.getElementById('playRecordBtn').style.display = 'inline-block';
                        document.getElementById('deleteRecordBtn').style.display = 'inline-block';
                        document.getElementById('recordingStatus').innerHTML = '<i class="fas fa-check-circle fa-3x text-success"></i><p class="mt-2 text-success">å½•éŸ³å®Œæˆ</p>';
                    }
                });
            }
            
            if (playBtn) {
                playBtn.addEventListener('click', function() {
                    const audioPreview = document.getElementById('audioPreview');
                    if (audioPreview.src) {
                        audioPreview.play();
                    }
                });
            }
            
            if (deleteBtn) {
                deleteBtn.addEventListener('click', function() {
                    resetVoiceRecorder();
                });
            }
        }
        
        // åˆå§‹åŒ–æ¼‚æµç“¶ç±»å‹åˆ‡æ¢
        function initBottleTypeSwitcher() {
            const textRadio = document.getElementById('bottleTypeText');
            const voiceRadio = document.getElementById('bottleTypeVoice');
            const textArea = document.getElementById('textContentArea');
            const voiceArea = document.getElementById('voiceContentArea');
            
            if (textRadio && voiceRadio) {
                textRadio.addEventListener('change', function() {
                    if (this.checked) {
                        textArea.style.display = 'block';
                        voiceArea.style.display = 'none';
                        resetVoiceRecorder();
                    }
                });
                
                voiceRadio.addEventListener('change', function() {
                    if (this.checked) {
                        textArea.style.display = 'none';
                        voiceArea.style.display = 'block';
                        initVoiceRecorder();
                    }
                });
            }
        }
        
        // æ›´æ–°æ¯æ—¥é™åˆ¶æ˜¾ç¤º
        function updateDailyLimitsDisplay(data) {
            const freeThrowsRemaining = Math.max(0, data.free_throws_remaining || 0);
            document.getElementById('freeThrowsRemaining').textContent = freeThrowsRemaining;
            document.getElementById('totalFreeThrows').textContent = window.DAILY_BOTTLE_LIMIT;
            
            // æ›´æ–°ç§¯åˆ†æ˜¾ç¤ºï¼ˆå¦‚æœè¿”å›äº†ç§¯åˆ†ä¿¡æ¯ï¼‰
            if (data.points !== undefined && window.userInfo) {
                window.userInfo.points = data.points;
                document.getElementById('userPoints').textContent = data.points;
            }
            
            // æ›´æ–°VIPç›¸å…³ä¿¡æ¯
            if (data.is_vip) {
                const vipThrowBonus = document.getElementById('vipThrowBonus');
                if (vipThrowBonus) {
                    vipThrowBonus.style.display = 'block';
                }
                
                const vipFreeThrows = document.getElementById('vipFreeThrows');
                if (vipFreeThrows) {
                    vipFreeThrows.style.display = 'block';
                    const vipFreeThrowsRemaining = Math.max(0, data.vip_free_throws_remaining || 0);
                    document.getElementById('vipFreeThrowsRemaining').textContent = vipFreeThrowsRemaining;
                    const vipExtraLimit = window.VIP_DAILY_BOTTLE_LIMIT - window.DAILY_BOTTLE_LIMIT;
                    document.getElementById('totalVipFreeThrows').textContent = vipExtraLimit;
                }
                
                const limitInfo = document.querySelector('.card-footer p:last-child small');
                if (limitInfo) {
                    limitInfo.textContent = `VIPç‰¹æƒï¼šæ¯å¤©æœ‰${window.VIP_DAILY_BOTTLE_LIMIT}æ¬¡å…è´¹æ‰”ç“¶æœºä¼šï¼ŒåŒ…æ‹¬${window.VIP_DAILY_BOTTLE_LIMIT - window.DAILY_BOTTLE_LIMIT}æ¬¡ä¸“å±ä¼šå‘˜æ¬¡æ•°ã€‚`;
                }
            } else {
                const vipThrowBonus = document.getElementById('vipThrowBonus');
                if (vipThrowBonus) vipThrowBonus.style.display = 'none';
                const vipFreeThrows = document.getElementById('vipFreeThrows');
                if (vipFreeThrows) vipFreeThrows.style.display = 'none';
            }
            
            // å½“å…è´¹æ¬¡æ•°ç”¨å®Œæ—¶ï¼Œæé†’ç”¨æˆ·å°†æ¶ˆè€—ç§¯åˆ†
            const pointsWarning = document.querySelector('.col-md-4 small.text-muted');
            if (pointsWarning) {
                if (freeThrowsRemaining <= 0 && (!data.is_vip || data.vip_free_throws_remaining <= 0)) {
                    pointsWarning.innerHTML = '<span class="text-danger"><i class="fas fa-exclamation-circle"></i> å…è´¹æ¬¡æ•°å·²ç”¨å®Œï¼Œå°†æ¶ˆè€—ç§¯åˆ†</span>';
                } else {
                    pointsWarning.textContent = 'æ¯ç“¶æ¶ˆè€—' + window.POINTS_PER_BOTTLE + 'ç§¯åˆ† (å…è´¹æ¬¡æ•°å†…ä¸æ¶ˆè€—)';
                }
            }
        }
        
        // æ›´æ–°VIPçŠ¶æ€æ˜¾ç¤º
        function updateVipStatusDisplay(data) {
            if (!window.userInfo) window.userInfo = {};
            window.userInfo.is_vip = data.is_vip;
            window.userInfo.vip_level = data.vip_level;
            window.userInfo.vip_expire_date = data.vip_expire_date;
            
            const locationCheckbox = document.getElementById('locationCheckbox');
            const locationHint = document.getElementById('locationHint');
            
            if (data.is_vip) {
                const vipThrowBonus = document.getElementById('vipThrowBonus');
                if (vipThrowBonus) vipThrowBonus.style.display = 'block';
                const vipFreeThrows = document.getElementById('vipFreeThrows');
                if (vipFreeThrows) vipFreeThrows.style.display = 'block';
                
                if (locationCheckbox) {
                    locationCheckbox.disabled = false;
                    locationCheckbox.checked = true;
                }
                if (locationHint) {
                    locationHint.textContent = '(VIPå¯å–æ¶ˆ)';
                }
            } else {
                if (locationCheckbox) {
                    locationCheckbox.disabled = true;
                    locationCheckbox.checked = true;
                }
                if (locationHint) {
                    locationHint.textContent = '(å¿…é€‰)';
                }
            }
        }
        
        // æ›´æ–°åœ°ç†ä½ç½®é¢„è§ˆ
        function updateLocationPreview(data) {
            const locationPreview = document.getElementById('locationPreview');
            if (!locationPreview) return;
            
            let previewText = `<i class="fas fa-map-marker-alt text-danger"></i> ${data.location}`;
            
            if (data.ip_address) {
                const isVip = window.userInfo && window.userInfo.is_vip;
                if (isVip) {
                    previewText += `<br><i class="fas fa-globe text-primary"></i> IP: ${data.ip_address}`;
                } else {
                    const maskedIp = data.ip_address.replace(/(\d+)\.(\d+)\.(\d+)\.(\d+)/, '$1.$2.**.***');
                    previewText += `<br><i class="fas fa-globe text-primary"></i> IP: ${maskedIp}`;
                }
            }
            
            locationPreview.innerHTML = previewText;
        }
        
        // è¯­éŸ³å½•åˆ¶ç›¸å…³å˜é‡
        let mediaRecorder = null;
        let audioChunks = [];
        let audioBlob = null;
        let recordingTimer = null;
        let recordingStartTime = null;
        
        // åˆå§‹åŒ–è¯­éŸ³å½•åˆ¶å™¨
        function initVoiceRecorder() {
            // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showAlert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒå½•éŸ³åŠŸèƒ½ï¼Œè¯·ä½¿ç”¨Chromeã€Firefoxæˆ–Edgeæµè§ˆå™¨', 'warning');
                return;
            }
        }
        
        // æ›´æ–°è®¡æ—¶å™¨
        function updateTimer() {
            if (recordingStartTime) {
                const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                document.getElementById('timerDisplay').textContent = 
                    String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0');
            }
        }
        
        // é‡ç½®å½•éŸ³å™¨
        function resetVoiceRecorder() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
            if (recordingTimer) {
                clearInterval(recordingTimer);
                recordingTimer = null;
            }
            
            audioChunks = [];
            audioBlob = null;
            recordingStartTime = null;
            
            document.getElementById('startRecordBtn').style.display = 'inline-block';
            document.getElementById('stopRecordBtn').style.display = 'none';
            document.getElementById('playRecordBtn').style.display = 'none';
            document.getElementById('deleteRecordBtn').style.display = 'none';
            document.getElementById('recordingStatus').innerHTML = '<i class="fas fa-microphone fa-3x text-muted"></i><p class="mt-2 text-muted">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹å½•éŸ³</p>';
            document.getElementById('recordingTimer').style.display = 'none';
            document.getElementById('audioPreview').style.display = 'none';
            document.getElementById('audioPreview').src = '';
            document.getElementById('audioBlob').value = '';
            document.getElementById('timerDisplay').textContent = '00:00';
        }
        
        // å°†dataURLè½¬æ¢ä¸ºBlob
        function dataURLtoBlob(dataurl) {
            const arr = dataurl.split(',');
            const mime = arr[0].match(/:(.*?);/)[1];
            const bstr = atob(arr[1]);
            let n = bstr.length;
            const u8arr = new Uint8Array(n);
            while (n--) {
                u8arr[n] = bstr.charCodeAt(n);
            }
            return new Blob([u8arr], { type: mime });
        }
        
        // è·å–ç”¨æˆ·æ¯æ—¥é™åˆ¶ï¼ˆç”¨äºåˆ·æ–°ï¼‰
        async function getDailyLimits() {
            try {
                const response = await fetch('api.php?action=get_daily_limits');
                const data = await response.json();
                if (data.success) {
                    updateDailyLimitsDisplay(data);
                }
            } catch (error) {
                Logger.error('è·å–æ¯æ—¥é™åˆ¶å¤±è´¥:', error);
            }
        }
        
        // æ›´æ–°ç§¯åˆ†æ˜¾ç¤º
        function updateUserPointsDisplay(isFree, pointsDeducted) {
            if (window.userInfo) {
                if (!isFree) {
                    window.userInfo.points -= pointsDeducted;
                    document.getElementById('userPoints').textContent = window.userInfo.points;
                }
            }
        }
        
        // æ›´æ–°æ‰”ç“¶æŒ‰é’®çŠ¶æ€
        function updateThrowButton(disable) {
            const throwButton = document.getElementById('throwButton');
            if (disable) {
                throwButton.disabled = true;
                throwButton.innerHTML = '<i class="fas fa-ban"></i> ä»Šæ—¥å·²è¾¾ä¸Šé™';
            } else {
                throwButton.disabled = false;
                throwButton.innerHTML = '<i class="fas fa-paper-plane"></i> æ‰”å‘å¤§æµ·';
            }
        }
        
    </script>
</body>
</html>