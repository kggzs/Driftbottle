<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¡æ¼‚æµç“¶ - æ¼‚æµç“¶</title>
    <link rel="stylesheet" href="assets/css/bootstrap/bootstrap.min.css">
    <link rel="stylesheet" href="assets/css/fontawesome/all.min.css">
    <link rel="stylesheet" href="assets/css/style.css">
    <script src="assets/js/bootstrap/bootstrap.bundle.min.js"></script>
    <script src="assets/js/utils.js"></script>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar navbar-expand">
        <div class="container">
            <a href="index.html" class="navbar-brand">æ¼‚æµç“¶</a>
            <div class="navbar-collapse">
                <ul class="navbar-nav">
                    <!-- åŠ¨æ€ç”Ÿæˆå¯¼èˆªé¡¹ -->
                </ul>
            </div>
        </div>
    </nav>
    
    <!-- ä¸»å†…å®¹ -->
    <div class="container">
        <div class="alert-container"></div>
        
        <div class="content">
            <div class="row">
                <div class="col-md-8 offset-md-2">
                    <!-- ç”¨æˆ·ä»Šæ—¥æ¡ç“¶é™åˆ¶ä¿¡æ¯ -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <p class="mb-0">
                                        <i class="fas fa-info-circle text-primary"></i> 
                                        ä»Šæ—¥è¿˜å¯æ¡èµ·: <span id="pickRemaining">--</span>/<span id="pickLimit">20</span> ä¸ªæ¼‚æµç“¶
                                        <span id="vipBonus" class="badge bg-warning text-dark ms-2" style="display: none;">
                                            <i class="fas fa-crown"></i> VIPé¢å¤–æ¬¡æ•°: +10/å¤©
                                        </span>
                                    </p>
                                </div>
                                <div>
                                    <span class="badge bg-info" id="totalPickedCount">å·²æ¡èµ·: 0 ä¸ª</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h2 class="text-center">æ¡ä¸€ä¸ªæ¼‚æµç“¶</h2>
                        </div>
                        <div class="card-body">
                            <div class="text-center mb-4">
                                <button id="pickBottleBtn" class="btn btn-success btn-lg">
                                    <i class="fas fa-search"></i> éšæœºæ¡ä¸€ä¸ªæ¼‚æµç“¶
                                </button>
                            </div>
                            
                            <div class="bottle-container mt-4">
                                <!-- æ¼‚æµç“¶å†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                            </div>
                        </div>
                        <div class="card-footer">
                            <div class="text-center text-muted">
                                <p><small>æ³¨æ„ï¼šä½ æ— æ³•æ¡åˆ°è‡ªå·±æ‰”å‡ºçš„æ¼‚æµç“¶ï¼Œæ¯ä¸ªæ¼‚æµç“¶ä»…èƒ½è¢«åŒä¸€ç”¨æˆ·æ¡èµ·ä¸€æ¬¡ã€‚</small></p>
                                <p><small>æ™®é€šç”¨æˆ·æ¯å¤©æœ€å¤šå¯æ¡èµ·20ä¸ªæ¼‚æµç“¶ï¼ŒVIPç”¨æˆ·æ¯å¤©å¯æ¡30ä¸ªï¼Œæ¬¡æ•°åœ¨æ¯å¤©0ç‚¹è‡ªåŠ¨åˆ·æ–°ï¼</small></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- é¡µè„š -->
    <footer class="bg-dark text-light py-4 mt-5">
        <div class="container text-center">
            <p>æ¼‚æµç“¶ &copy; 2023 ç‰ˆæƒæ‰€æœ‰</p>
        </div>
    </footer>
    
    <script src="assets/js/app.js"></script>
    <script>
        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            checkAuth(function(isLoggedIn) {
                if (!isLoggedIn) {
                    window.location.href = 'login.html';
                    return;
                }
                
                // æ£€æŸ¥ç”¨æˆ·VIPçŠ¶æ€
                checkVipStatus();
                
                // è·å–ç”¨æˆ·é™åˆ¶ä¿¡æ¯
                getDailyLimits();
                
                // è·å–å·²æ¡èµ·çš„ç“¶å­æ•°é‡
                getPickedBottlesCount();
                
                // åˆå§‹åŒ–æ¡ç“¶é¡µé¢
                initPickBottlePage();
            });
        });
        
        // è·å–ç”¨æˆ·æ¯æ—¥é™åˆ¶
        function getDailyLimits() {
            fetch('api.php/get_daily_limits')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const isVip = data.is_vip;
                    const pickLimit = isVip ? 30 : 20;
                    
                    document.getElementById('pickRemaining').textContent = data.pick_remaining;
                    document.getElementById('pickLimit').textContent = pickLimit;
                    
                    // æ˜¾ç¤ºVIPé¢å¤–æ¬¡æ•°æ ‡ç­¾
                    const vipBonusElement = document.getElementById('vipBonus');
                    if (isVip) {
                        vipBonusElement.style.display = 'inline-block';
                    } else {
                        vipBonusElement.style.display = 'none';
                    }
                    
                    // å¦‚æœæ˜¯VIPç”¨æˆ·ï¼Œæ›´æ–°é™åˆ¶ä¿¡æ¯
                    if (isVip) {
                        const limitText = document.querySelector('.card-footer p:last-child small');
                        limitText.textContent = 'æ™®é€šç”¨æˆ·æ¯å¤©æœ€å¤šå¯æ¡èµ·20ä¸ªæ¼‚æµç“¶ï¼ŒVIPç”¨æˆ·æ¯å¤©å¯æ¡30ä¸ªï¼Œæ¬¡æ•°åœ¨æ¯å¤©0ç‚¹è‡ªåŠ¨åˆ·æ–°ï¼';
                    }
                    
                    // æ›´æ–°æŒ‰é’®çŠ¶æ€
                    updatePickButton(data.pick_remaining <= 0);
                    
                    // è°ƒè¯•ä¿¡æ¯
                    Logger.log("æ¯æ—¥é™åˆ¶æ•°æ®:", data);
                    Logger.log(`ç”¨æˆ·çŠ¶æ€: ${isVip ? 'VIPä¼šå‘˜' : 'æ™®é€šç”¨æˆ·'}, ä»Šæ—¥å‰©ä½™æ¡ç“¶æ¬¡æ•°: ${data.pick_remaining}/${pickLimit}`);
                }
            })
            .catch(error => Logger.error('Error:', error));
        }
        
        // è·å–å·²æ¡èµ·çš„æ¼‚æµç“¶æ•°é‡
        function getPickedBottlesCount() {
            fetch('api.php/user_picked_bottles')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const bottleCount = data.bottles.length;
                    document.getElementById('totalPickedCount').textContent = `å·²æ¡èµ·: ${bottleCount} ä¸ª`;
                }
            })
            .catch(error => Logger.error('Error:', error));
        }
        
        // æ›´æ–°å·²æ¡èµ·æ•°é‡
        function updatePickedCount() {
            const countElement = document.getElementById('totalPickedCount');
            const currentCount = parseInt(countElement.textContent.match(/\d+/)[0]);
            countElement.textContent = `å·²æ¡èµ·: ${currentCount + 1} ä¸ª`;
        }
        
        // æ›´æ–°æ¡ç“¶æŒ‰é’®çŠ¶æ€
        function updatePickButton(disable) {
            const pickBtn = document.getElementById('pickBottleBtn');
            if (disable) {
                pickBtn.disabled = true;
                pickBtn.innerHTML = '<i class="fas fa-ban"></i> ä»Šæ—¥å·²è¾¾ä¸Šé™';
            } else {
                pickBtn.disabled = false;
                pickBtn.innerHTML = '<i class="fas fa-search"></i> éšæœºæ¡ä¸€ä¸ªæ¼‚æµç“¶';
            }
        }
        
        // æ˜¾ç¤ºæ¡åˆ°çš„æ¼‚æµç“¶
        function displayBottle(bottle) {
            const container = document.querySelector('.bottle-container');
            
            // æ ¼å¼åŒ–æ—¶é—´
            const throwTime = new Date(bottle.throw_time).toLocaleString();
            
            // è·å–è¡¨æƒ…
            let moodEmoji = '';
            switch (bottle.mood) {
                case 'å¼€å¿ƒ': moodEmoji = 'ğŸ˜Š'; break;
                case 'éš¾è¿‡': moodEmoji = 'ğŸ˜¢'; break;
                case 'å¹³é™': moodEmoji = 'ğŸ˜Œ'; break;
                case 'æ„¤æ€’': moodEmoji = 'ğŸ˜¡'; break;
                case 'æœŸå¾…': moodEmoji = 'ğŸ¤©'; break;
                case 'å¿§éƒ': moodEmoji = 'ğŸ˜”'; break;
                default: moodEmoji = 'ğŸ˜¶';
            }
            
            // å¤„ç†ç”¨æˆ·åæ˜¾ç¤ºï¼ˆéåŒ¿åç”¨æˆ·åå¯ç‚¹å‡»ï¼‰
            const usernameDisplay = !bottle.is_anonymous ? 
                `<a href="user_profile.html?id=${bottle.user_id}" class="text-primary username-link">${bottle.username}</a>` : 
                `<span class="text-primary">${bottle.username}</span>`;
            
            let html = `
                <div class="bottle-card p-4 border rounded bg-light">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            ${usernameDisplay}
                            <span class="badge bg-secondary ms-2">${bottle.gender}</span>
                            <span class="badge bg-info ms-2">${bottle.mood} ${moodEmoji}</span>
                            ${bottle.is_vip ? '<span class="badge bg-warning text-dark ms-2"><i class="fas fa-crown"></i> VIPä¼šå‘˜</span>' : ''}
                        </div>
                        <small class="text-muted">${throwTime}</small>
                    </div>
                    
                    <div class="bottle-content mb-3">
                        <p>${bottle.content}</p>
                        ${bottle.signature ? `<p class="text-muted small fst-italic mt-2">â€”â€”${bottle.signature}</p>` : ''}
                    </div>
                    
                    ${displayLocationInfo(bottle)}
                    
                    <div class="bottle-actions d-flex justify-content-between align-items-center">
                        <div>
                            <button class="btn btn-sm ${bottle.has_liked ? 'btn-danger' : 'btn-outline-danger'} like-btn" data-id="${bottle.id}">
                                <i class="fas fa-heart"></i> 
                                <span class="like-count">${bottle.like_count}</span>
                            </button>
                        </div>
                        
                        <div class="ms-2">
                            <button class="btn btn-sm btn-success comment-btn" data-id="${bottle.id}" data-bs-toggle="collapse" data-bs-target="#commentForm">
                                <i class="fas fa-comment"></i> è¯„è®ºå¹¶æ‰”å›å¤§æµ·
                            </button>
                        </div>
                    </div>
                    
                    <div class="collapse mt-3" id="commentForm">
                        <form id="bottleCommentForm" data-id="${bottle.id}">
                            <div class="mb-3">
                                <textarea class="form-control" id="commentContent" rows="3" placeholder="å†™ä¸‹ä½ çš„è¯„è®º..."></textarea>
                            </div>
                            <div class="text-end">
                                <button type="submit" class="btn btn-primary">å‘é€è¯„è®º</button>
                            </div>
                        </form>
                    </div>
                `;
            
            // å¦‚æœæœ‰è¯„è®ºï¼Œæ˜¾ç¤ºè¯„è®ºåŒº
            if (bottle.comments && bottle.comments.length > 0) {
                html += `<div class="comments-section mt-4">
                    <h5>è¯„è®º (${bottle.comments.length})</h5>
                    <div class="comments-list">`;
                
                bottle.comments.forEach(comment => {
                    html += `
                        <div class="comment-item p-2 mb-2 border-bottom">
                            <div class="d-flex justify-content-between">
                                <a href="user_profile.html?id=${comment.user_id}" class="text-primary username-link">${comment.username}</a>
                                <small class="text-muted">${new Date(comment.created_at).toLocaleString()}</small>
                            </div>
                            <p class="mb-0">${comment.content}</p>
                        </div>
                    `;
                });
                
                html += `</div></div>`;
            }
            
            html += `</div>`;
            
            container.innerHTML = html;
            
            // æ·»åŠ ç‚¹èµäº‹ä»¶
            const likeBtn = container.querySelector('.like-btn');
            likeBtn.addEventListener('click', function() {
                const bottleId = this.dataset.id;
                likeBottle(bottleId, this);
            });
            
            // æ·»åŠ è¯„è®ºè¡¨å•æäº¤äº‹ä»¶
            const commentForm = container.querySelector('#bottleCommentForm');
            commentForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const bottleId = this.dataset.id;
                const content = document.getElementById('commentContent').value.trim();
                
                if (content === '') {
                    showAlert('è¯·è¾“å…¥è¯„è®ºå†…å®¹', 'danger');
                    return;
                }
                
                commentAndThrowBottle(bottleId, content);
            });
        }
        
        // ç‚¹èµæ¼‚æµç“¶
        function likeBottle(bottleId, btnElement) {
            fetch('api.php/like_bottle', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ bottle_id: bottleId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const likeCountElement = btnElement.querySelector('.like-count');
                    let likeCount = parseInt(likeCountElement.textContent);
                    
                    if (data.action === 'like') {
                        likeCount++;
                        btnElement.classList.remove('btn-outline-danger');
                        btnElement.classList.add('btn-danger');
                    } else {
                        likeCount--;
                        btnElement.classList.remove('btn-danger');
                        btnElement.classList.add('btn-outline-danger');
                    }
                    
                    likeCountElement.textContent = likeCount;
                }
            })
            .catch(error => Logger.error('Error:', error));
        }
        
        // è¯„è®ºå¹¶æ‰”å›å¤§æµ·
        function commentAndThrowBottle(bottleId, content) {
            fetch('api.php/comment_bottle', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ bottle_id: bottleId, content: content })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('è¯„è®ºæˆåŠŸï¼Œæ¼‚æµç“¶å·²é‡æ–°æ‰”å›å¤§æµ·', 'success');
                    
                    // æ¸…ç©ºè¯„è®ºåŒºå’Œæ¼‚æµç“¶
                    document.querySelector('.bottle-container').innerHTML = '';
                    
                    // é‡æ–°å¯ç”¨æ¡ç“¶æŒ‰é’®
                    const pickBtn = document.getElementById('pickBottleBtn');
                    pickBtn.disabled = false;
                    pickBtn.innerHTML = '<i class="fas fa-search"></i> éšæœºæ¡ä¸€ä¸ªæ¼‚æµç“¶';
                    
                    // æ›´æ–°å‰©ä½™æ¬¡æ•°
                    getDailyLimits();
                } else {
                    showAlert(data.message, 'danger');
                }
            })
            .catch(error => {
                Logger.error('Error:', error);
                showAlert('è¯„è®ºå¤±è´¥ï¼Œè¯·ç¨åå†è¯•', 'danger');
            });
        }
        
        // æ˜¾ç¤ºä½ç½®å’ŒIPä¿¡æ¯
        function displayLocationInfo(bottle) {
            if (!bottle.ip_address && !bottle.location) {
                return '';
            }
            
            let html = '<div class="location-info small text-muted mb-3">';
            
            if (bottle.location) {
                html += `<p><i class="fas fa-map-marker-alt"></i> ${bottle.location}</p>`;
            }
            
            if (bottle.ip_address) {
                html += `<p><i class="fas fa-globe"></i> IP: ${bottle.ip_address}</p>`;
            }
            
            html += '</div>';
            return html;
        }
        
        // æ£€æŸ¥VIPçŠ¶æ€
        function checkVipStatus() {
            fetch('api.php/check_vip_status')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // ä¿å­˜VIPçŠ¶æ€åˆ°å…¨å±€å¯¹è±¡
                    if (!window.userInfo) window.userInfo = {};
                    window.userInfo.is_vip = data.is_vip;
                    window.userInfo.vip_level = data.vip_level;
                    window.userInfo.vip_expire_date = data.vip_expire_date;
                    
                    // å¦‚æœæ˜¯VIPç”¨æˆ·ï¼Œæ›´æ–°UIæ˜¾ç¤º
                    if (data.is_vip) {
                        // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ VIPä¸“å±UIå…ƒç´ 
                        const cardHeader = document.querySelector('.card-header h2');
                        cardHeader.innerHTML = `æ¡ä¸€ä¸ªæ¼‚æµç“¶ <span class="badge bg-warning text-dark"><i class="fas fa-crown"></i> VIPæ¨¡å¼</span>`;
                    }
                }
            })
            .catch(error => Logger.error('Error:', error));
        }
    </script>
</body>
</html>