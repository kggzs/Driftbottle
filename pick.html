<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¡æ¼‚æµç“¶ - æ¼‚æµç“¶</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="assets/css/bootstrap/bootstrap.min.css">
    <link rel="stylesheet" href="assets/css/fontawesome/all.min.css">
    <link rel="stylesheet" href="assets/css/style.css">
    <script src="assets/js/bootstrap/bootstrap.bundle.min.js"></script>
    <script src="assets/js/utils.js"></script>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar navbar-expand">
        <div class="container">
            <a href="index.html" class="navbar-brand">æ¼‚æµç“¶</a>
            <div class="navbar-collapse">
                <ul class="navbar-nav">
                    <!-- åŠ¨æ€ç”Ÿæˆå¯¼èˆªé¡¹ -->
                </ul>
            </div>
        </div>
    </nav>
    
    <!-- ä¸»å†…å®¹ -->
    <div class="container">
        <div class="alert-container"></div>
        
        <div class="content">
            <div class="row">
                <div class="col-md-8 offset-md-2">
                    <!-- ç”¨æˆ·ä»Šæ—¥æ¡ç“¶é™åˆ¶ä¿¡æ¯ -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <p class="mb-0">
                                        <i class="fas fa-info-circle text-primary"></i> 
                                        ä»Šæ—¥è¿˜å¯æ¡èµ·: <span id="pickRemaining">--</span>/<span id="pickLimit">20</span> ä¸ªæ¼‚æµç“¶
                                        <span id="vipBonus" class="badge bg-warning text-dark ms-2" style="display: none;">
                                            <i class="fas fa-crown"></i> VIPé¢å¤–æ¬¡æ•°: +<span id="vipExtraCount">10</span>/å¤©
                                        </span>
                                    </p>
                                </div>
                                <div>
                                    <span class="badge bg-info" id="totalPickedCount">å·²æ¡èµ·: 0 ä¸ª</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h2 class="text-center">æ¡ä¸€ä¸ªæ¼‚æµç“¶</h2>
                        </div>
                        <div class="card-body">
                            <div class="text-center mb-4">
                                <button id="pickBottleBtn" class="btn btn-success btn-lg">
                                    <i class="fas fa-search"></i> éšæœºæ¡ä¸€ä¸ªæ¼‚æµç“¶
                                </button>
                            </div>
                            
                            <div class="bottle-container mt-4">
                                <!-- æ¼‚æµç“¶å†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                            </div>
                        </div>
                        <div class="card-footer">
                            <div class="text-center text-muted">
                                <p><small>æ³¨æ„ï¼šä½ æ— æ³•æ¡åˆ°è‡ªå·±æ‰”å‡ºçš„æ¼‚æµç“¶ï¼Œæ¯ä¸ªæ¼‚æµç“¶ä»…èƒ½è¢«åŒä¸€ç”¨æˆ·æ¡èµ·ä¸€æ¬¡ã€‚</small></p>
                                <p><small>æ™®é€šç”¨æˆ·æ¯å¤©æœ€å¤šå¯æ¡èµ·20ä¸ªæ¼‚æµç“¶ï¼ŒVIPç”¨æˆ·æ¯å¤©å¯æ¡30ä¸ªï¼Œæ¬¡æ•°åœ¨æ¯å¤©0ç‚¹è‡ªåŠ¨åˆ·æ–°ï¼</small></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- é¡µè„š -->
    <footer class="bg-dark text-light py-4 mt-5">
        <div class="container text-center">
            <p class="mb-2">æ¼‚æµç“¶ &copy; 2023 ç‰ˆæƒæ‰€æœ‰</p>
        </div>
    </footer>
    
    <script>
        // æ ‡è®°é¡µé¢å·²æœ‰è‡ªå·±çš„åˆå§‹åŒ–é€»è¾‘ï¼Œé¿å… app.js é‡å¤åˆå§‹åŒ–
        window.pageHasCustomInit = true;
    </script>
    <script src="assets/js/app.js"></script>
    <script>
        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', async function() {
            // é»˜è®¤é…ç½®å¸¸é‡ï¼ˆåç»­ä¼šä»APIè·å–ï¼‰
            window.DAILY_PICK_LIMIT = 20;
            window.VIP_DAILY_PICK_LIMIT = 30;
            window.VIP_PICK_EXTRA = window.VIP_DAILY_PICK_LIMIT - window.DAILY_PICK_LIMIT;
            
            try {
                // æ£€æŸ¥ç™»å½•çŠ¶æ€
                const authResponse = await fetch('api.php?action=check_auth');
                const authData = await authResponse.json();
                
                if (!authData.success || !authData.loggedIn) {
                    window.location.href = 'login.html';
                    return;
                }
                
                // ä¿å­˜ç”¨æˆ·ä¿¡æ¯
                if (!window.userInfo) window.userInfo = {};
                window.userInfo.id = authData.user_id;
                window.userInfo.username = authData.username;
                
                // å¹¶è¡ŒåŠ è½½æ‰€æœ‰æ•°æ®
                const [configRes, limitsRes, vipRes, pickedRes] = await Promise.allSettled([
                    fetch('api.php?action=get_system_config'),
                    fetch('api.php?action=get_daily_limits'),
                    fetch('api.php?action=check_vip_status'),
                    fetch('api.php?action=user_picked_bottles')
                ]);
                
                // å¤„ç†ç³»ç»Ÿé…ç½®
                if (configRes.status === 'fulfilled') {
                    try {
                        const config = await configRes.value.json();
                        if (config.success) {
                            window.DAILY_PICK_LIMIT = config.DAILY_PICK_LIMIT || window.DAILY_PICK_LIMIT;
                            window.VIP_DAILY_PICK_LIMIT = config.VIP_DAILY_PICK_LIMIT || window.VIP_DAILY_PICK_LIMIT;
                            window.VIP_PICK_EXTRA = window.VIP_DAILY_PICK_LIMIT - window.DAILY_PICK_LIMIT;
                            
                            const vipExtraCount = document.getElementById('vipExtraCount');
                            if (vipExtraCount) {
                                vipExtraCount.textContent = window.VIP_PICK_EXTRA;
                            }
                        }
                    } catch (e) {
                        Logger.error('è§£æç³»ç»Ÿé…ç½®å¤±è´¥:', e);
                    }
                }
                
                // å¤„ç†æ¯æ—¥é™åˆ¶
                if (limitsRes.status === 'fulfilled') {
                    try {
                        const limitsData = await limitsRes.value.json();
                        if (limitsData.success) {
                            updateDailyLimitsDisplay(limitsData);
                        }
                    } catch (e) {
                        Logger.error('è§£ææ¯æ—¥é™åˆ¶å¤±è´¥:', e);
                    }
                }
                
                // å¤„ç†VIPçŠ¶æ€
                if (vipRes.status === 'fulfilled') {
                    try {
                        const vipData = await vipRes.value.json();
                        if (vipData.success) {
                            updateVipStatusDisplay(vipData);
                        }
                    } catch (e) {
                        Logger.error('è§£æVIPçŠ¶æ€å¤±è´¥:', e);
                    }
                }
                
                // å¤„ç†å·²æ¡èµ·çš„ç“¶å­æ•°é‡
                if (pickedRes.status === 'fulfilled') {
                    try {
                        const pickedData = await pickedRes.value.json();
                        if (pickedData.success) {
                            const bottleCount = pickedData.bottles ? pickedData.bottles.length : 0;
                            document.getElementById('totalPickedCount').textContent = `å·²æ¡èµ·: ${bottleCount} ä¸ª`;
                        }
                    } catch (e) {
                        Logger.error('è§£æå·²æ¡èµ·ç“¶å­å¤±è´¥:', e);
                    }
                }
                
                // åˆå§‹åŒ–æ¡ç“¶é¡µé¢
                initPickBottlePage();
                
                // æ‰‹åŠ¨æ›´æ–°å¯¼èˆªæ 
                updateNavBarManually();
            } catch (error) {
                Logger.error('é¡µé¢åˆå§‹åŒ–é”™è¯¯:', error);
                showAlert('é¡µé¢åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•', 'danger');
            }
        });
        
        // æ›´æ–°æ¯æ—¥é™åˆ¶æ˜¾ç¤º
        function updateDailyLimitsDisplay(data) {
            const isVip = data.is_vip;
            const pickLimit = isVip ? window.VIP_DAILY_PICK_LIMIT : window.DAILY_PICK_LIMIT;
            
            document.getElementById('pickRemaining').textContent = data.pick_remaining || 0;
            document.getElementById('pickLimit').textContent = pickLimit;
            
            const vipBonusElement = document.getElementById('vipBonus');
            if (isVip) {
                vipBonusElement.style.display = 'inline-block';
            } else {
                vipBonusElement.style.display = 'none';
            }
            
            const limitText = document.querySelector('.card-footer p:last-child small');
            if (limitText) {
                limitText.textContent = `æ™®é€šç”¨æˆ·æ¯å¤©æœ€å¤šå¯æ¡èµ·${window.DAILY_PICK_LIMIT}ä¸ªæ¼‚æµç“¶ï¼ŒVIPç”¨æˆ·æ¯å¤©å¯æ¡${window.VIP_DAILY_PICK_LIMIT}ä¸ªï¼Œæ¬¡æ•°åœ¨æ¯å¤©0ç‚¹è‡ªåŠ¨åˆ·æ–°ï¼`;
            }
            
            updatePickButton(data.pick_remaining <= 0);
        }
        
        // æ›´æ–°VIPçŠ¶æ€æ˜¾ç¤º
        function updateVipStatusDisplay(data) {
            if (!window.userInfo) window.userInfo = {};
            window.userInfo.is_vip = data.is_vip;
        }
        
        // æ‰‹åŠ¨æ›´æ–°å¯¼èˆªæ 
        function updateNavBarManually() {
            const navbarContainer = document.querySelector('.navbar-nav');
            if (!navbarContainer) return;
            
            if (window.userInfo && window.userInfo.id) {
                navbarContainer.innerHTML = `
                    <li class="nav-item"><a href="index.html" class="nav-link">é¦–é¡µ</a></li>
                    <li class="nav-item"><a href="throw.html" class="nav-link">æ‰”æ¼‚æµç“¶</a></li>
                    <li class="nav-item"><a href="pick.html" class="nav-link">æ¡æ¼‚æµç“¶</a></li>
                    <li class="nav-item"><a href="profile.html" class="nav-link">ä¸ªäººä¸­å¿ƒ</a></li>
                    <li class="nav-item"><a href="#" class="nav-link logout-btn">é€€å‡ºç™»å½•</a></li>
                `;
                
                const logoutBtn = document.querySelector('.logout-btn');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', async (e) => {
                        e.preventDefault();
                        try {
                            const response = await fetch('api.php?action=logout');
                            const data = await response.json();
                            if (data.success) {
                                window.location.href = 'login.html';
                            }
                        } catch (error) {
                            Logger.error('é€€å‡ºç™»å½•å¤±è´¥:', error);
                        }
                    });
                }
            } else {
                navbarContainer.innerHTML = `
                    <li class="nav-item"><a href="index.html" class="nav-link">é¦–é¡µ</a></li>
                    <li class="nav-item"><a href="login.html" class="nav-link">ç™»å½•</a></li>
                    <li class="nav-item"><a href="register.html" class="nav-link">æ³¨å†Œ</a></li>
                `;
            }
        }
        
        // è·å–ç”¨æˆ·æ¯æ—¥é™åˆ¶ï¼ˆç”¨äºåˆ·æ–°ï¼‰
        async function getDailyLimits() {
            try {
                const response = await fetch('api.php?action=get_daily_limits');
                const data = await response.json();
                if (data.success) {
                    updateDailyLimitsDisplay(data);
                }
            } catch (error) {
                Logger.error('è·å–æ¯æ—¥é™åˆ¶å¤±è´¥:', error);
            }
        }
        
        // è·å–å·²æ¡èµ·çš„æ¼‚æµç“¶æ•°é‡ï¼ˆç”¨äºåˆ·æ–°ï¼‰
        async function getPickedBottlesCount() {
            try {
                const response = await fetch('api.php?action=user_picked_bottles');
                const data = await response.json();
                if (data.success) {
                    const bottleCount = data.bottles ? data.bottles.length : 0;
                    document.getElementById('totalPickedCount').textContent = `å·²æ¡èµ·: ${bottleCount} ä¸ª`;
                }
            } catch (error) {
                Logger.error('è·å–å·²æ¡èµ·ç“¶å­å¤±è´¥:', error);
            }
        }
        
        // æ›´æ–°å·²æ¡èµ·æ•°é‡
        function updatePickedCount() {
            const countElement = document.getElementById('totalPickedCount');
            const currentCount = parseInt(countElement.textContent.match(/\d+/)[0]);
            countElement.textContent = `å·²æ¡èµ·: ${currentCount + 1} ä¸ª`;
        }
        
        // æ›´æ–°æ¡ç“¶æŒ‰é’®çŠ¶æ€
        function updatePickButton(disable) {
            const pickBtn = document.getElementById('pickBottleBtn');
            if (disable) {
                pickBtn.disabled = true;
                pickBtn.innerHTML = '<i class="fas fa-ban"></i> ä»Šæ—¥å·²è¾¾ä¸Šé™';
            } else {
                pickBtn.disabled = false;
                pickBtn.innerHTML = '<i class="fas fa-search"></i> éšæœºæ¡ä¸€ä¸ªæ¼‚æµç“¶';
            }
        }
        
        // æ ¼å¼åŒ–æ—¶é•¿æ˜¾ç¤º
        function formatDuration(seconds) {
            if (!seconds) return '00:00';
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${String(secs).padStart(2, '0')}`;
        }
        
        // æ˜¾ç¤ºæ¡åˆ°çš„æ¼‚æµç“¶
        function displayBottle(bottle) {
            const container = document.querySelector('.bottle-container');
            
            // æ ¼å¼åŒ–æ—¶é—´
            const throwTime = new Date(bottle.throw_time).toLocaleString();
            
            // è·å–è¡¨æƒ…
            let moodEmoji = '';
            switch (bottle.mood) {
                case 'å¼€å¿ƒ': moodEmoji = 'ğŸ˜Š'; break;
                case 'éš¾è¿‡': moodEmoji = 'ğŸ˜¢'; break;
                case 'å¹³é™': moodEmoji = 'ğŸ˜Œ'; break;
                case 'æ„¤æ€’': moodEmoji = 'ğŸ˜¡'; break;
                case 'æœŸå¾…': moodEmoji = 'ğŸ¤©'; break;
                case 'å¿§éƒ': moodEmoji = 'ğŸ˜”'; break;
                default: moodEmoji = 'ğŸ˜¶';
            }
            
            // å¤„ç†ç”¨æˆ·åæ˜¾ç¤ºï¼ˆéåŒ¿åç”¨æˆ·åå¯ç‚¹å‡»ï¼‰
            const usernameDisplay = !bottle.is_anonymous ? 
                `<a href="user_profile.html?id=${bottle.user_id}" class="text-primary username-link">${bottle.username}</a>` : 
                `<span class="text-primary">${bottle.username}</span>`;
            
            let html = `
                <div class="bottle-card p-4 border rounded bg-light">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            ${usernameDisplay}
                            <span class="badge bg-secondary ms-2">${bottle.gender}</span>
                            <span class="badge bg-info ms-2">${bottle.mood} ${moodEmoji}</span>
                            ${bottle.is_vip ? '<span class="badge bg-warning text-dark ms-2"><i class="fas fa-crown"></i> VIPä¼šå‘˜</span>' : ''}
                        </div>
                        <small class="text-muted">${throwTime}</small>
                    </div>
                    
                    <div class="bottle-content mb-3">
                        ${bottle.bottle_type === 'voice' && bottle.audio_file ? `
                            <div class="voice-bottle-container">
                                <div class="alert alert-info">
                                    <i class="fas fa-microphone"></i> è¿™æ˜¯ä¸€ä¸ªè¯­éŸ³æ¼‚æµç“¶
                                </div>
                                <audio controls class="w-100 mt-2" id="bottleAudio_${bottle.id}">
                                    <source src="${bottle.audio_file}" type="audio/webm">
                                    <source src="${bottle.audio_file}" type="audio/mpeg">
                                    æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾
                                </audio>
                                ${bottle.audio_duration ? `<small class="text-muted d-block mt-1">æ—¶é•¿: ${formatDuration(bottle.audio_duration)}</small>` : ''}
                            </div>
                        ` : `
                            <p>${bottle.content}</p>
                        `}
                        ${bottle.signature ? `<p class="text-muted small fst-italic mt-2">â€”â€”${bottle.signature}</p>` : ''}
                    </div>
                    
                    ${displayLocationInfo(bottle)}
                    
                    <div class="bottle-actions d-flex justify-content-between align-items-center">
                        <div>
                            <button class="btn btn-sm ${bottle.has_liked ? 'btn-danger' : 'btn-outline-danger'} like-btn" data-id="${bottle.id}">
                                <i class="fas fa-heart"></i> 
                                <span class="like-count">${bottle.like_count}</span>
                            </button>
                            <button class="btn btn-sm btn-outline-warning report-btn ms-2" data-target-type="bottle" data-target-id="${bottle.id}" title="ä¸¾æŠ¥è¿è§„å†…å®¹">
                                <i class="fas fa-flag"></i> ä¸¾æŠ¥
                            </button>
                        </div>
                        
                        <div class="ms-2">
                            <button class="btn btn-sm btn-success comment-btn" data-id="${bottle.id}" data-bs-toggle="collapse" data-bs-target="#commentForm">
                                <i class="fas fa-comment"></i> è¯„è®ºå¹¶æ‰”å›å¤§æµ·
                            </button>
                        </div>
                    </div>
                    
                    <div class="collapse mt-3" id="commentForm">
                        <form id="bottleCommentForm" data-id="${bottle.id}">
                            <div class="mb-3">
                                <textarea class="form-control" id="commentContent" rows="3" placeholder="å†™ä¸‹ä½ çš„è¯„è®º..."></textarea>
                            </div>
                            <div class="text-end">
                                <button type="submit" class="btn btn-primary">å‘é€è¯„è®º</button>
                            </div>
                        </form>
                    </div>
                `;
            
            // å¦‚æœæœ‰è¯„è®ºï¼Œæ˜¾ç¤ºè¯„è®ºåŒº
            if (bottle.comments && bottle.comments.length > 0) {
                html += `<div class="comments-section mt-4">
                    <h5>è¯„è®º (${bottle.comments.length})</h5>
                    <div class="comments-list">`;
                
                bottle.comments.forEach(comment => {
                    html += `
                        <div class="comment-item p-2 mb-2 border-bottom">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <a href="user_profile.html?id=${comment.user_id}" class="text-primary username-link">${comment.username}</a>
                                    <small class="text-muted ms-2">${new Date(comment.created_at).toLocaleString()}</small>
                                </div>
                                <button class="btn btn-sm btn-outline-warning report-btn" data-target-type="comment" data-target-id="${comment.id}" title="ä¸¾æŠ¥è¿è§„è¯„è®º">
                                    <i class="fas fa-flag"></i>
                                </button>
                            </div>
                            <p class="mb-0">${comment.content}</p>
                        </div>
                    `;
                });
                
                html += `</div></div>`;
            }
            
            html += `</div>`;
            
            container.innerHTML = html;
            
            // æ·»åŠ ç‚¹èµäº‹ä»¶
            const likeBtn = container.querySelector('.like-btn');
            likeBtn.addEventListener('click', function() {
                const bottleId = this.dataset.id;
                likeBottle(bottleId, this);
            });
            
            // æ·»åŠ è¯„è®ºè¡¨å•æäº¤äº‹ä»¶
            const commentForm = container.querySelector('#bottleCommentForm');
            commentForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const bottleId = this.dataset.id;
                const content = document.getElementById('commentContent').value.trim();
                
                if (content === '') {
                    showAlert('è¯·è¾“å…¥è¯„è®ºå†…å®¹', 'danger');
                    return;
                }
                
                commentAndThrowBottle(bottleId, content);
            });
        }
        
        // ç‚¹èµæ¼‚æµç“¶
        function likeBottle(bottleId, btnElement) {
            fetch('api.php?action=like_bottle', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ bottle_id: bottleId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const likeCountElement = btnElement.querySelector('.like-count');
                    let likeCount = parseInt(likeCountElement.textContent);
                    
                    if (data.action === 'like') {
                        likeCount++;
                        btnElement.classList.remove('btn-outline-danger');
                        btnElement.classList.add('btn-danger');
                    } else {
                        likeCount--;
                        btnElement.classList.remove('btn-danger');
                        btnElement.classList.add('btn-outline-danger');
                    }
                    
                    likeCountElement.textContent = likeCount;
                }
            })
            .catch(error => Logger.error('Error:', error));
        }
        
        // è¯„è®ºå¹¶æ‰”å›å¤§æµ·
        function commentAndThrowBottle(bottleId, content) {
            fetch('api.php?action=comment_bottle', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ bottle_id: bottleId, content: content })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('è¯„è®ºæˆåŠŸï¼Œæ¼‚æµç“¶å·²é‡æ–°æ‰”å›å¤§æµ·', 'success');
                    
                    // æ¸…ç©ºè¯„è®ºåŒºå’Œæ¼‚æµç“¶
                    document.querySelector('.bottle-container').innerHTML = '';
                    
                    // é‡æ–°å¯ç”¨æ¡ç“¶æŒ‰é’®
                    const pickBtn = document.getElementById('pickBottleBtn');
                    pickBtn.disabled = false;
                    pickBtn.innerHTML = '<i class="fas fa-search"></i> éšæœºæ¡ä¸€ä¸ªæ¼‚æµç“¶';
                    
                    // æ›´æ–°å‰©ä½™æ¬¡æ•°
                    getDailyLimits();
                } else {
                    showAlert(data.message, 'danger');
                }
            })
            .catch(error => {
                Logger.error('Error:', error);
                showAlert('è¯„è®ºå¤±è´¥ï¼Œè¯·ç¨åå†è¯•', 'danger');
            });
        }
        
        // æ˜¾ç¤ºä½ç½®å’ŒIPä¿¡æ¯
        function displayLocationInfo(bottle) {
            if (!bottle.ip_address && !bottle.location) {
                return '';
            }
            
            let html = '<div class="location-info small text-muted mb-3">';
            
            if (bottle.location) {
                html += `<p><i class="fas fa-map-marker-alt"></i> ${bottle.location}</p>`;
            }
            
            if (bottle.ip_address) {
                html += `<p><i class="fas fa-globe"></i> IP: ${bottle.ip_address}</p>`;
            }
            
            html += '</div>';
            return html;
        }
        
        // æ›´æ–°VIPçŠ¶æ€æ˜¾ç¤ºï¼ˆå·²åœ¨ä¸»åˆå§‹åŒ–ä¸­è°ƒç”¨ï¼‰
        
        // ä¸¾æŠ¥åŠŸèƒ½
        document.addEventListener('click', function(e) {
            if (e.target.closest('.report-btn')) {
                const btn = e.target.closest('.report-btn');
                const targetType = btn.dataset.targetType;
                const targetId = btn.dataset.targetId;
                showReportModal(targetType, targetId);
            }
        });
        
        // æ˜¾ç¤ºä¸¾æŠ¥æ¨¡æ€æ¡†
        function showReportModal(targetType, targetId) {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.id = 'reportModal';
            modal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">ä¸¾æŠ¥${targetType === 'bottle' ? 'æ¼‚æµç“¶' : 'è¯„è®º'}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="reportForm">
                                <input type="hidden" name="target_type" value="${targetType}">
                                <input type="hidden" name="target_id" value="${targetId}">
                                <div class="mb-3">
                                    <label for="reportReason" class="form-label">ä¸¾æŠ¥ç†ç”±</label>
                                    <select class="form-select mb-2" id="reportReasonSelect" onchange="handleReportReasonSelect()">
                                        <option value="">è¯·é€‰æ‹©æˆ–è‡ªå®šä¹‰ä¸¾æŠ¥ç†ç”±</option>
                                        <option value="æ¶‰åŠè¿æ³•è¿è§„å†…å®¹">æ¶‰åŠè¿æ³•è¿è§„å†…å®¹</option>
                                        <option value="åŒ…å«è‰²æƒ…ã€ä½ä¿—ä¿¡æ¯">åŒ…å«è‰²æƒ…ã€ä½ä¿—ä¿¡æ¯</option>
                                        <option value="åŒ…å«æš´åŠ›ã€ææ€–å†…å®¹">åŒ…å«æš´åŠ›ã€ææ€–å†…å®¹</option>
                                        <option value="å­˜åœ¨æ¶æ„æ”»å‡»ã€è¾±éª‚">å­˜åœ¨æ¶æ„æ”»å‡»ã€è¾±éª‚</option>
                                        <option value="å‘å¸ƒè™šå‡ä¿¡æ¯ã€è°£è¨€">å‘å¸ƒè™šå‡ä¿¡æ¯ã€è°£è¨€</option>
                                        <option value="æ¶‰åŠè¯ˆéª—ã€å¹¿å‘Š">æ¶‰åŠè¯ˆéª—ã€å¹¿å‘Š</option>
                                        <option value="ä¾µçŠ¯ä»–äººéšç§">ä¾µçŠ¯ä»–äººéšç§</option>
                                        <option value="å…¶ä»–è¿è§„å†…å®¹">å…¶ä»–è¿è§„å†…å®¹</option>
                                        <option value="custom">è‡ªå®šä¹‰ç†ç”±</option>
                                    </select>
                                    <textarea class="form-control" id="reportReason" name="reason" rows="4" required placeholder="è¯·è¯¦ç»†æè¿°ä¸¾æŠ¥åŸå› ..."></textarea>
                                    <small class="form-text text-muted">æ‚¨ä¹Ÿå¯ä»¥åœ¨ä¸Šæ–¹é€‰æ‹©é»˜è®¤ç†ç”±ï¼Œæˆ–åœ¨ä¸‹æ–¹çš„æ–‡æœ¬æ¡†ä¸­è‡ªå®šä¹‰ä¸¾æŠ¥ç†ç”±</small>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                            <button type="button" class="btn btn-warning" id="submitReportBtn">æäº¤ä¸¾æŠ¥</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            // å¤„ç†ä¸¾æŠ¥ç†ç”±é€‰æ‹©
            window.handleReportReasonSelect = function() {
                const select = document.getElementById('reportReasonSelect');
                const textarea = document.getElementById('reportReason');
                if (select.value && select.value !== 'custom') {
                    textarea.value = select.value;
                    textarea.disabled = false;
                } else if (select.value === 'custom') {
                    textarea.value = '';
                    textarea.disabled = false;
                    textarea.focus();
                } else {
                    textarea.value = '';
                    textarea.disabled = false;
                }
            };
            
            // æäº¤ä¸¾æŠ¥
            document.getElementById('submitReportBtn').addEventListener('click', async function() {
                const form = document.getElementById('reportForm');
                const formData = new FormData(form);
                const reason = formData.get('reason').trim();
                
                if (!reason) {
                    alert('è¯·è¾“å…¥ä¸¾æŠ¥ç†ç”±');
                    return;
                }
                
                if (reason.length > 500) {
                    alert('ä¸¾æŠ¥ç†ç”±ä¸èƒ½è¶…è¿‡500å­—ç¬¦');
                    return;
                }
                
                this.disabled = true;
                this.textContent = 'æäº¤ä¸­...';
                
                try {
                    const response = await fetch('api.php?action=submit_report', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            target_type: formData.get('target_type'),
                            target_id: parseInt(formData.get('target_id')),
                            reason: reason
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        bsModal.hide();
                        showAlert('ä¸¾æŠ¥å·²æäº¤ï¼Œæˆ‘ä»¬ä¼šå°½å¿«å®¡æ ¸', 'success');
                        modal.remove();
                    } else {
                        alert(data.message || 'æäº¤ä¸¾æŠ¥å¤±è´¥');
                        this.disabled = false;
                        this.textContent = 'æäº¤ä¸¾æŠ¥';
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('æäº¤ä¸¾æŠ¥å¤±è´¥ï¼Œè¯·ç¨åå†è¯•');
                    this.disabled = false;
                    this.textContent = 'æäº¤ä¸¾æŠ¥';
                }
            });
            
            // æ¨¡æ€æ¡†å…³é—­æ—¶ç§»é™¤DOMå…ƒç´ 
            modal.addEventListener('hidden.bs.modal', function() {
                modal.remove();
            });
        }
        
        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        function showAlert(message, type = 'info') {
            const alertContainer = document.querySelector('.alert-container');
            if (!alertContainer) return;
            
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            alertContainer.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }
    </script>
</body>
</html>