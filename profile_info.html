<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>个人信息 - 漂流瓶</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="assets/css/bootstrap/bootstrap.min.css">
    <link rel="stylesheet" href="assets/css/fontawesome/all.min.css">
    <link rel="stylesheet" href="assets/css/style.css">
    <script src="assets/js/bootstrap/bootstrap.bundle.min.js"></script>
    <script src="assets/js/utils.js"></script>
    <script>
        window.pageHasCustomInit = true;
    </script>
    <style>
        .alert-container {
            z-index: 9999;
            pointer-events: none;
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 500px;
            padding: 0 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
        }
        
        .alert-container .alert {
            pointer-events: auto;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-width: 100%;
            width: 100%;
            margin-bottom: 10px;
            border-radius: 8px;
            animation: slideDown 0.3s ease-out;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @media (max-width: 576px) {
            .alert-container {
                top: 10px;
                padding: 0 0.75rem;
            }
            
            .alert-container .alert {
                font-size: 14px;
                padding: 0.75rem;
            }
        }
        
        .profile-nav {
            background-color: #f8f9fa;
            padding: 0.5rem 0;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid #dee2e6;
        }
        
        .profile-nav .nav-tabs {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .profile-nav .nav-link {
            color: #495057;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0;
            transition: all 0.2s ease;
        }
        
        .profile-nav .nav-link:hover {
            color: #0d6efd;
            background-color: rgba(13, 110, 253, 0.05);
        }
        
        .profile-nav .nav-link.active {
            color: #0d6efd;
            background-color: transparent;
            border-bottom: 2px solid #0d6efd;
            border-top: none;
            border-left: none;
            border-right: none;
        }
        
        .content {
            padding-top: 1rem;
        }
        
        .card {
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            border: 1px solid rgba(0, 0, 0, 0.125);
            transition: box-shadow 0.15s ease-in-out;
        }
        
        .card:hover {
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }
        
        .card-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid rgba(0, 0, 0, 0.125);
            font-weight: 600;
        }
        
        .message-item {
            transition: all 0.2s ease;
        }
        
        .message-item:hover {
            box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.1);
        }
        
        .message-item[data-is-read="0"]:hover {
            background-color: #e7f3ff;
        }
        
        .message-item {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border: 1px solid #90caf9;
        }
        
        .message-item[data-is-read="1"] {
            background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%);
            border: 1px solid #bdbdbd;
        }
        
        .unread-badge {
            font-size: 0.9rem;
            padding: 0.4rem 0.8rem;
            border-radius: 4px;
            font-weight: 600;
            background: linear-gradient(135deg, #2196f3 0%, #64b5f6 100%) !important;
            border: none;
            box-shadow: 0 2px 4px rgba(33, 150, 243, 0.3);
            animation: pulse 2s infinite;
            display: inline-block;
            min-width: 50px;
            text-align: center;
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.8;
            }
        }
        
        .message-item[data-is-read="0"] {
            position: relative;
        }
        
        .message-item[data-is-read="0"]::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(180deg, #2196f3 0%, #64b5f6 100%);
            border-radius: 0 4px 4px 0;
        }
        
        .message-content {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }
        
        .message-content .message-info {
            flex: 1;
        }
        
        .message-content .message-info h6 {
            font-size: 1rem;
            font-weight: 600;
            color: #1976d2;
            margin-bottom: 0.5rem;
        }
        
        .message-content .message-info p {
            font-size: 0.95rem;
            color: #424242;
            margin-bottom: 0.25rem;
        }
        
        .message-content .message-info small {
            font-size: 0.85rem;
        }
        
        /* 确保积分和按钮不换行 */
        .d-flex.flex-nowrap {
            white-space: nowrap;
        }
        
        .btn-group.flex-nowrap {
            flex-wrap: nowrap;
        }
        
        @media (max-width: 768px) {
            .profile-nav {
                padding: 0.4rem 0;
                margin-bottom: 1rem;
            }
            
            .profile-nav .nav-link {
                padding: 0.4rem 0.75rem;
                font-size: 0.9rem;
            }
            
            /* 移动端弹窗优化 */
            .modal-dialog {
                margin: 0.5rem;
                max-width: calc(100% - 1rem);
            }
            
            .modal-content {
                border-radius: 0.5rem;
            }
            
            .modal-header {
                padding: 0.75rem 1rem;
            }
            
            .modal-body {
                padding: 1rem;
                max-height: calc(100vh - 200px);
                overflow-y: auto;
            }
            
            .modal-footer {
                padding: 0.75rem 1rem;
            }
            
            /* 按钮组优化 */
            .btn-group-sm .btn {
                padding: 0.25rem 0.5rem;
                font-size: 0.75rem;
            }
            
            /* 支付方式按钮优化 */
            .payment-method-btn {
                padding: 0.35rem 0.2rem;
                font-size: 0.7rem;
                transition: all 0.2s;
                min-height: 60px;
            }
            
            .payment-method-btn i {
                font-size: 1rem;
                display: block;
                margin-bottom: 0.15rem;
            }
            
            .payment-method-btn small {
                font-size: 0.65rem;
            }
            
            /* 选中状态更明显 */
            .payment-method-radio:checked + .payment-method-btn {
                border-width: 2px !important;
                font-weight: 700 !important;
                transform: scale(1.08) !important;
                box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.35) !important;
            }
            
            .payment-method-radio:checked + .btn-primary {
                box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.35) !important;
            }
            
            .payment-method-radio:checked + .btn-success {
                box-shadow: 0 0 0 0.25rem rgba(25, 135, 84, 0.35) !important;
            }
            
            .payment-method-radio:checked + .btn-info {
                box-shadow: 0 0 0 0.25rem rgba(13, 202, 240, 0.35) !important;
            }
            
            .payment-method-radio:checked + .btn-secondary {
                box-shadow: 0 0 0 0.25rem rgba(108, 117, 125, 0.35) !important;
            }
            
            /* 桌面端支付方式按钮 */
            @media (min-width: 768px) {
                .payment-method-btn {
                    padding: 0.3rem 0.15rem;
                    font-size: 0.65rem;
                    min-height: 55px;
                }
                
                .payment-method-btn i {
                    font-size: 0.9rem;
                }
            }
        }
        
        /* 弹窗响应式优化 */
        .modal-dialog-centered {
            min-height: calc(100% - 3.5rem);
        }
        
        .modal-dialog-scrollable .modal-body {
            max-height: calc(100vh - 300px);
            overflow-y: auto;
        }
        
        @media (max-width: 576px) {
            .modal-dialog-scrollable .modal-body {
                max-height: calc(100vh - 250px);
            }
            
            .modal-dialog {
                margin: 0.25rem;
                max-width: calc(100% - 0.5rem);
            }
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand">
        <div class="container">
            <a href="index.html" class="navbar-brand">漂流瓶</a>
            <div class="navbar-collapse">
                <ul class="navbar-nav">
                    <!-- 动态生成导航项 -->
                </ul>
            </div>
        </div>
    </nav>
    
    <!-- 个人中心导航 -->
    <div class="profile-nav">
        <div class="container">
            <ul class="nav nav-tabs">
                <li class="nav-item">
                    <a class="nav-link active" href="profile_info.html">个人信息</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="profile_bottles.html">我扔出的漂流瓶</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="profile_picked.html">我捡到的漂流瓶</a>
                </li>
            </ul>
        </div>
    </div>
    
    <!-- 主内容 -->
    <div class="container">
        <div class="alert-container" id="alertContainer"></div>
        
        <div class="content">
            <div class="row">
                <div class="col-md-10 offset-md-1">
                    <!-- 个人资料部分 -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h2 class="text-center">个人资料</h2>
                        </div>
                        <div class="card-body">
                            <div class="profile-container">
                                <div class="text-center">
                                    <p>正在加载个人资料...</p>
                                </div>
                            </div>
                            
                            <!-- VIP会员升级模块 -->
                            <div class="vip-container card mb-4">
                                <div class="card-header bg-warning text-dark">
                                    <h4><i class="fas fa-crown"></i> VIP会员特权</h4>
                                </div>
                                <div class="card-body">
                                    <div class="vip-benefits mb-4">
                                        <h5>会员特权：</h5>
                                        <ul>
                                            <li>查看完整IP地址和地理位置信息</li>
                                            <li>每日签到获得额外积分</li>
                                            <li>每日扔瓶和捡瓶次数大幅提高（每天重置）</li>
                                            <li>专属VIP标识，让你更加醒目</li>
                                            <li>所有特权每天自动刷新，无使用次数限制</li>
                                        </ul>
                                    </div>
                                    
                                    <div class="row mb-3">
                                        <div class="col-12">
                                            <div class="alert alert-info">
                                                <i class="fas fa-coins text-warning"></i> 您当前积分: <span id="userPointsForVip" class="fw-bold">--</span>
                                                <div class="mt-2 small">使用积分开通VIP会员，积分可通过每日签到、扔漂流瓶、收到点赞等方式获得</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="alert alert-warning">
                                        <i class="fas fa-info-circle"></i> VIP特权说明：
                                        <ul class="mb-0 small" id="vipLimitsInfo">
                                            <li>加载中...</li>
                                        </ul>
                                    </div>
                                    
                                    <div class="vip-status">
                                        <h5 class="mb-3">选择开通时长：</h5>
                                        <div class="row">
                                            <div class="col-6 col-md-3 mb-3">
                                                <button class="btn btn-outline-warning w-100" data-months="1" data-points="100">
                                                    <div>1个月</div>
                                                    <div><i class="fas fa-coins"></i> 100积分</div>
                                                </button>
                                            </div>
                                            <div class="col-6 col-md-3 mb-3">
                                                <button class="btn btn-outline-warning w-100" data-months="3" data-points="250">
                                                    <div>3个月</div>
                                                    <div><i class="fas fa-coins"></i> 250积分</div>
                                                </button>
                                            </div>
                                            <div class="col-6 col-md-3 mb-3">
                                                <button class="btn btn-outline-warning w-100" data-months="6" data-points="450">
                                                    <div>6个月</div>
                                                    <div><i class="fas fa-coins"></i> 450积分</div>
                                                </button>
                                            </div>
                                            <div class="col-6 col-md-3 mb-3">
                                                <button class="btn btn-outline-warning w-100" data-months="12" data-points="800">
                                                    <div>12个月</div>
                                                    <div><i class="fas fa-coins"></i> 800积分</div>
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <div id="currentVipStatus" class="mt-4 text-center">
                                            <!-- VIP状态将在这里动态显示 -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 个性签名设置 -->
                            <div class="signature-container mt-4">
                                <h4>个性签名</h4>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="signatureInput" placeholder="设置你的个性签名...">
                                    <button class="btn btn-primary" id="updateSignatureBtn">保存</button>
                                </div>
                                <small class="text-muted">个性签名会显示在你的漂流瓶上，让捡到瓶子的人更了解你</small>
                            </div>
                            
                            <!-- 签到模块 -->
                            <div class="checkin-container mt-4">
                                <div class="card">
                                    <div class="card-header bg-primary text-white">
                                        <h4 class="mb-0">每日签到</h4>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-7">
                                                <div class="checkin-status">
                                                    <p>连续签到: <span id="consecutiveDays">--</span> 天</p>
                                                    <p>本月签到: <span id="monthlyCheckins">--</span> 天</p>
                                                    <p>签到可获得<strong>1</strong>积分，连续签到7天额外奖励<strong>7</strong>积分！</p>
                                                    <p id="vipCheckinBonus" class="d-none text-warning">
                                                        <i class="fas fa-crown"></i> VIP会员每次签到额外获得<strong>2</strong>积分！
                                                    </p>
                                                </div>
                                            </div>
                                            <div class="col-md-5 text-center">
                                                <button class="btn btn-success btn-lg" id="checkinBtn">
                                                    <i class="fas fa-calendar-check"></i> 今日签到
                                                </button>
                                                <div id="checkinCompleted" class="mt-2 d-none">
                                                    <span class="badge bg-success"><i class="fas fa-check"></i> 今日已签到</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 消息中心 -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h3 class="mb-1">
                                我的消息 
                                <span class="badge bg-primary" id="unreadBadge" style="font-size: 1rem; padding: 0.3rem 0.6rem; display: inline-block; border-radius: 4px;">0</span>
                            </h3>
                            <small class="text-muted">点击未读消息可标记为已读</small>
                        </div>
                        <div class="card-body">
                            <div class="messages-container">
                                <div class="text-center" id="loadingMessages">
                                    <p>正在加载消息...</p>
                                </div>
                                <div id="messagesList"></div>
                                <div class="text-center d-none" id="noMessages">
                                    <p>暂无消息</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 充值记录弹窗 -->
    <div class="modal fade" id="rechargeHistoryModal" tabindex="-1" aria-labelledby="rechargeHistoryModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="rechargeHistoryModalLabel">
                        <i class="fas fa-history"></i> 充值记录
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="rechargeHistoryLoading" class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                        <p class="mt-2">正在加载充值记录...</p>
                    </div>
                    <div id="rechargeHistoryContent" class="d-none">
                        <!-- 桌面端表格显示 -->
                        <div class="table-responsive d-none d-md-block">
                            <table class="table table-striped table-hover table-sm">
                                <thead>
                                    <tr>
                                        <th>订单号</th>
                                        <th>充值金额</th>
                                        <th>获得积分</th>
                                        <th>支付方式</th>
                                        <th>状态</th>
                                        <th>创建时间</th>
                                    </tr>
                                </thead>
                                <tbody id="rechargeHistoryTableBody">
                                    <!-- 充值记录将在这里动态加载 -->
                                </tbody>
                            </table>
                        </div>
                        <!-- 移动端卡片显示 -->
                        <div class="d-md-none" id="rechargeHistoryCardBody">
                            <!-- 充值记录卡片将在这里动态加载 -->
                        </div>
                        <div id="rechargeHistoryEmpty" class="text-center py-4 d-none">
                            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                            <p class="text-muted">暂无充值记录</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 充值弹窗 -->
    <div class="modal fade" id="rechargeModal" tabindex="-1" aria-labelledby="rechargeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="rechargeModalLabel">
                        <i class="fas fa-wallet"></i> 积分充值
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info alert-sm py-2">
                        <i class="fas fa-info-circle"></i> 当前积分比例：<span id="pointsRatioDisplay">--</span> 积分/元
                    </div>
                    
                    <div class="mb-3">
                        <label for="rechargeAmount" class="form-label">充值金额（元）</label>
                        <input type="number" class="form-control form-control-lg" id="rechargeAmount" min="0.01" max="10000" step="0.01" placeholder="请输入充值金额">
                        <small class="form-text text-muted">最小：0.01元，最大：10000元</small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">预计获得积分</label>
                        <div class="alert alert-warning mb-0 py-2" id="expectedPoints">
                            <i class="fas fa-coins"></i> <span id="expectedPointsValue" class="fw-bold">0</span> 积分
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">支付方式</label>
                        <div class="row g-2" id="paymentMethodsContainer">
                            <!-- 支付方式将在这里动态加载 -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary btn-sm" id="confirmRechargeBtn">
                        <i class="fas fa-check"></i> 确认充值
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 页脚 -->
    <footer class="bg-dark text-light py-4 mt-5">
        <div class="container text-center">
            <p class="mb-2">漂流瓶 &copy; 2023 版权所有</p>
        </div>
    </footer>
    
    <script src="assets/js/app.js"></script>
    <script>
        // 加载消息
        function loadUserMessages() {
            fetch('api.php?action=get_messages')
                .then(response => response.json())
                .then(data => {
                    const loadingMessages = document.getElementById('loadingMessages');
                    const messagesList = document.getElementById('messagesList');
                    const noMessages = document.getElementById('noMessages');
                    const unreadBadge = document.getElementById('unreadBadge');
                    
                    if (loadingMessages) loadingMessages.classList.add('d-none');
                    
                    if (data.success && data.messages && data.messages.length > 0) {
                        let unreadCount = 0;
                        let messagesHtml = '';
                        
                        data.messages.forEach(message => {
                            if (!message.is_read) unreadCount++;
                            const messageTime = new Date(message.created_at).toLocaleString();
                            const messageClass = message.is_read ? '' : 'border-start border-primary border-3';
                            const cursorStyle = !message.is_read ? 'cursor: pointer;' : '';
                            
                            // 根据消息类型显示不同的内容
                            let messageDisplayContent = message.display_content || message.content || message.bottle_content || '消息内容';
                            let messageTitle = message.from_username || '未知用户';
                            let isOwnerWarning = false; // 是否为被举报人的警告消息
                            
                            if (message.type === '举报反馈') {
                                // 举报反馈消息显示特殊样式
                                messageDisplayContent = message.content || messageDisplayContent;
                                // 判断是否为被举报人通知（内容包含"您的"且包含"被"处理字样）
                                if (messageDisplayContent.includes('您的') && (messageDisplayContent.includes('被删除') || messageDisplayContent.includes('被屏蔽') || messageDisplayContent.includes('被处理'))) {
                                    isOwnerWarning = true;
                                }
                            }
                            
                            // 如果是被举报人警告消息，使用红色警告样式
                            const warningClass = isOwnerWarning ? 'border-danger border-3 bg-danger bg-opacity-10' : '';
                            const warningIcon = isOwnerWarning ? '<i class="fas fa-exclamation-triangle text-danger me-2"></i>' : '';
                            
                            const badgeColor = isOwnerWarning ? 'bg-danger' : 'bg-info';
                            const textColor = isOwnerWarning ? 'text-danger fw-bold' : '';
                            const badgeHtml = message.type === '举报反馈' ? ' <span class="badge ' + badgeColor + '">举报反馈</span>' : '';
                            
                            messagesHtml += '<div class="card mb-2 ' + messageClass + ' ' + warningClass + ' message-item" ' +
                                     'data-message-id="' + message.id + '" ' +
                                     'data-is-read="' + (message.is_read ? '1' : '0') + '" ' +
                                     'style="' + cursorStyle + '"' +
                                     (!message.is_read ? ' title="点击标记为已读"' : '') + '>' +
                                    '<div class="card-body">' +
                                        '<div class="message-content">' +
                                            '<div class="message-info">' +
                                                '<h6>' + warningIcon + '来自: ' + messageTitle + badgeHtml + '</h6>' +
                                                '<p class="' + textColor + '">' + messageDisplayContent + '</p>' +
                                                '<small class="text-muted">' + messageTime + '</small>' +
                                            '</div>' +
                                            (!message.is_read ? '<span class="badge unread-badge">未读</span>' : '') +
                                        '</div>' +
                                    '</div>' +
                                '</div>';
                        });
                        
                        messagesList.innerHTML = messagesHtml;
                        if (unreadBadge) {
                            unreadBadge.textContent = unreadCount;
                            // 如果没有未读消息，隐藏徽章
                            if (unreadCount === 0) {
                                unreadBadge.style.display = 'none';
                            } else {
                                unreadBadge.style.display = 'inline-block';
                            }
                        }
                        if (noMessages) noMessages.classList.add('d-none');
                        
                        // 绑定消息点击事件（标记为已读）
                        messagesList.querySelectorAll('.message-item[data-is-read="0"]').forEach(messageCard => {
                            messageCard.addEventListener('click', function() {
                                const messageId = this.getAttribute('data-message-id');
                                if (!messageId) return;
                                
                                // 如果已经标记为已读，不再处理
                                if (this.getAttribute('data-is-read') === '1') return;
                                
                                markMessageAsRead(messageId, this);
                            });
                        });
                    } else {
                        messagesList.innerHTML = '';
                        if (noMessages) noMessages.classList.remove('d-none');
                        if (unreadBadge) {
                            unreadBadge.textContent = '0';
                            unreadBadge.style.display = 'none';
                        }
                    }
                })
                .catch(error => {
                    Logger.error('加载消息失败:', error);
                    const loadingMessages = document.getElementById('loadingMessages');
                    if (loadingMessages) {
                        loadingMessages.innerHTML = '<p class="text-danger">加载消息失败，请稍后再试</p>';
                    }
                });
        }
        
        // 标记消息为已读
        function markMessageAsRead(messageId, messageElement) {
            fetch('api.php?action=mark_message_read', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message_id: messageId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 更新消息元素状态
                    messageElement.setAttribute('data-is-read', '1');
                    messageElement.classList.remove('border-start', 'border-primary', 'border-3');
                    messageElement.style.cursor = '';
                    messageElement.removeAttribute('title');
                    
                    // 移除未读标记
                    const unreadBadge = messageElement.querySelector('.unread-badge');
                    if (unreadBadge) {
                        unreadBadge.remove();
                    }
                    
                    // 更新未读消息数量
                    const unreadBadgeHeader = document.getElementById('unreadBadge');
                    if (unreadBadgeHeader) {
                        const currentCount = parseInt(unreadBadgeHeader.textContent) || 0;
                        const newCount = Math.max(0, currentCount - 1);
                        unreadBadgeHeader.textContent = newCount;
                        
                        // 如果没有未读消息了，隐藏徽章
                        if (newCount === 0) {
                            unreadBadgeHeader.style.display = 'none';
                        } else {
                            unreadBadgeHeader.style.display = 'inline-block';
                        }
                    }
                    
                    if (typeof Logger !== 'undefined' && Logger.log) {
                        Logger.log('消息已标记为已读:', messageId);
                    }
                } else {
                    if (typeof Logger !== 'undefined' && Logger.error) {
                        Logger.error('标记消息已读失败:', data.message);
                    }
                }
            })
            .catch(error => {
                Logger.error('标记消息已读失败:', error);
            });
        }
        
        // 页面初始化
        async function initProfileInfoPage() {
            Logger.log("个人信息页面初始化开始...");
            
            try {
                window.userInfo = {};
                
                let alertContainer = document.getElementById('alertContainer');
                if (!alertContainer) {
                    alertContainer = document.createElement('div');
                    alertContainer.id = 'alertContainer';
                    alertContainer.className = 'alert-container position-fixed top-0 start-0 end-0 p-3 d-flex flex-column align-items-center';
                    document.body.appendChild(alertContainer);
                }
                
                const checkinBtn = document.getElementById('checkinBtn');
                if (checkinBtn) {
                    checkinBtn.disabled = true;
                    checkinBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> 加载中...';
                }
                
                const authResponse = await fetch('api.php?action=check_auth');
                const authData = await authResponse.json();
                
                if (!authData.success || !authData.loggedIn) {
                    window.location.href = 'login.html';
                    return;
                }
                
                window.userInfo.id = authData.user_id;
                window.userInfo.username = authData.username;
                window.userInfo.points = authData.points || 0;
                
                // 并行加载数据
                const [userRes, vipRes, pointsRes, limitsRes, vipPointsRes, messagesRes] = await Promise.allSettled([
                    fetch('api.php?action=user_info'),
                    fetch('api.php?action=check_vip_status'),
                    fetch('api.php?action=get_points_config'),
                    fetch('api.php?action=get_limits_config'),
                    fetch('api.php?action=get_vip_points_config'),
                    fetch('api.php?action=get_messages')
                ]);
                
                if (userRes.status === 'fulfilled') {
                    try {
                        const userData = await userRes.value.json();
                        if (userData.success) {
                            updateUserProfileDisplay(userData);
                        }
                    } catch (e) {
                        Logger.error('解析用户信息失败:', e);
                    }
                }
                
                if (vipRes.status === 'fulfilled') {
                    try {
                        const vipData = await vipRes.value.json();
                        if (vipData.success) {
                            updateVipStatus(vipData);
                            setTimeout(() => bindVipButtons(), 100);
                        }
                    } catch (e) {
                        Logger.error('解析VIP状态失败:', e);
                    }
                }
                
                if (pointsRes.status === 'fulfilled') {
                    try {
                        const pointsData = await pointsRes.value.json();
                        if (pointsData.success) {
                            updatePointsConfigDisplay(pointsData);
                        }
                    } catch (e) {
                        Logger.error('解析积分配置失败:', e);
                    }
                }
                
                if (limitsRes.status === 'fulfilled') {
                    try {
                        const limitsData = await limitsRes.value.json();
                        if (limitsData.success) {
                            updateLimitsConfigDisplay(limitsData);
                        }
                    } catch (e) {
                        Logger.error('解析限制配置失败:', e);
                    }
                }
                
                if (vipPointsRes.status === 'fulfilled') {
                    try {
                        const vipPointsData = await vipPointsRes.value.json();
                        if (vipPointsData.success) {
                            updateVipPointsConfigDisplay(vipPointsData);
                        }
                    } catch (e) {
                        Logger.error('解析VIP价格配置失败:', e);
                    }
                }
                
                // 加载消息
                loadUserMessages();
                
                updateNavBarManually();
                
                setTimeout(() => {
                    bindVipButtons();
                    bindOtherEvents();
                    
                    const checkinBtn = document.getElementById('checkinBtn');
                    if (checkinBtn && !checkinBtn.hasAttribute('data-bound')) {
                        checkinBtn.setAttribute('data-bound', 'true');
                        checkinBtn.addEventListener('click', function() {
                            if (this.disabled) return;
                            if (this.dataset.processing === 'true') return;
                            this.dataset.processing = 'true';
                            
                            const originalText = this.innerHTML;
                            this.disabled = true;
                            this.innerHTML = '<span class="spinner-border spinner-border-sm"></span> 签到中...';
                            
                            fetch('api.php?action=user_checkin', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({})
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    showAlert('签到成功！获得 ' + data.points_earned + ' 积分', 'success');
                                    
                                    if (window.userInfo) {
                                        window.userInfo.points += data.points_earned;
                                        const userPointsElement = document.getElementById('userPoints');
                                        if (userPointsElement) {
                                            userPointsElement.textContent = window.userInfo.points;
                                        }
                                        const userPointsForVip = document.getElementById('userPointsForVip');
                                        if (userPointsForVip) {
                                            userPointsForVip.textContent = window.userInfo.points;
                                        }
                                    }
                                    
                                    const consecutiveDaysElement = document.getElementById('consecutiveDays');
                                    if (consecutiveDaysElement) {
                                        consecutiveDaysElement.textContent = data.consecutive_days;
                                    }
                                    
                                    const monthlyCheckinsElement = document.getElementById('monthlyCheckins');
                                    if (monthlyCheckinsElement) {
                                        monthlyCheckinsElement.textContent = data.monthly_checkins;
                                    }
                                    
                                    this.disabled = true;
                                    this.innerHTML = '今日已签到';
                                    
                                    const checkinCompleted = document.getElementById('checkinCompleted');
                                    if (checkinCompleted) {
                                        checkinCompleted.classList.remove('d-none');
                                    }
                                } else {
                                    showAlert(data.message || '签到失败，请稍后再试', 'danger');
                                    this.disabled = false;
                                    this.innerHTML = originalText;
                                }
                                
                                this.dataset.processing = 'false';
                            })
                            .catch(error => {
                                Logger.error('签到失败:', error);
                                showAlert('签到失败，请稍后再试', 'danger');
                                this.disabled = false;
                                this.innerHTML = originalText;
                                this.dataset.processing = 'false';
                            });
                        });
                    }
                }, 200);
            } catch (error) {
                Logger.error('页面初始化错误:', error);
                showAlert('页面加载失败，请刷新重试', 'danger');
            }
        }
        
        // 从 profile.html 提取的函数（简化版）
        function updateUserProfileDisplay(data) {
            const user = data.user;
            
            window.userInfo = {
                ...window.userInfo,
                id: user.id,
                username: user.username,
                gender: user.gender,
                points: user.points,
                signature: user.signature || '',
                bottle_count: user.bottle_count,
                like_count: user.like_count,
                is_vip: user.is_vip || 0,
                vip_level: user.vip_level || 0,
                vip_expire_date: user.vip_expire_date || null,
                experience: user.experience || 0,
                level: user.level || 1,
                next_level_exp: user.next_level_exp || 0,
                current_level_exp: user.current_level_exp || 0,
                exp_progress: user.exp_progress || 0
            };
            
            const signatureInput = document.getElementById('signatureInput');
            if (signatureInput) {
                signatureInput.value = user.signature || '';
            }
            
            if (user.is_vip) {
                const vipCheckinBonus = document.getElementById('vipCheckinBonus');
                if (vipCheckinBonus) {
                    vipCheckinBonus.classList.remove('d-none');
                }
            }
            const userPointsForVip = document.getElementById('userPointsForVip');
            if (userPointsForVip) {
                userPointsForVip.textContent = user.points;
            }
            
            const experience = user.experience || 0;
            const level = user.level || 1;
            const expProgress = user.exp_progress || 0;
            const expNeeded = (user.next_level_exp || 0) - experience;
            
            const profileHtml = `
                <div class="row">
                    <div class="col-md-6">
                        <h4>
                            ${user.username} 
                            <span class="badge bg-info ms-2">Lv.${level}</span>
                            ${user.is_vip ? '<span class="badge bg-warning text-dark"><i class="fas fa-crown"></i> VIP会员</span>' : ''}
                        </h4>
                        
                        <div class="mb-3 mt-3">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <small class="text-muted">经验值: ${experience}</small>
                                <small class="text-muted">距离下一级还需: ${expNeeded > 0 ? expNeeded : 0}</small>
                            </div>
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated bg-info" 
                                     role="progressbar" 
                                     style="width: ${expProgress}%" 
                                     aria-valuenow="${expProgress}" 
                                     aria-valuemin="0" 
                                     aria-valuemax="100">
                                    ${expProgress.toFixed(1)}%
                                </div>
                            </div>
                            <div class="d-flex justify-content-between mt-1">
                                <small class="text-muted">Lv.${level}</small>
                                <small class="text-muted">Lv.${level + 1}</small>
                            </div>
                        </div>
                        
                        <p>性别: ${user.gender}</p>
                        <p>注册时间: ${new Date(user.created_at).toLocaleString()}</p>
                        ${user.signature ? `<p>个性签名: ${user.signature}</p>` : ''}
                        ${user.is_vip ? `<p class="text-warning">VIP到期时间: ${new Date(user.vip_expire_date).toLocaleDateString()}</p>` : ''}
                    </div>
                    <div class="col-md-6">
                        <div class="stats">
                            <p class="d-flex align-items-center flex-nowrap gap-2">
                                <i class="fas fa-coins text-warning"></i> 
                                <span class="text-nowrap">积分: <span id="userPoints" class="fw-bold">${user.points}</span></span>
                                <div class="btn-group btn-group-sm flex-nowrap" role="group">
                                    <button class="btn btn-primary" id="rechargeBtn" data-bs-toggle="modal" data-bs-target="#rechargeModal">
                                        <i class="fas fa-wallet"></i> 充值
                                    </button>
                                    <button class="btn btn-info" id="rechargeHistoryBtn" data-bs-toggle="modal" data-bs-target="#rechargeHistoryModal">
                                        <i class="fas fa-history"></i> 记录
                                    </button>
                                </div>
                            </p>
                            <p><i class="fas fa-bottle-water text-primary"></i> 扔出瓶子: ${user.bottle_count}</p>
                            <p><i class="fas fa-heart text-danger"></i> 收到点赞: ${user.like_count}</p>
                        </div>
                    </div>
                </div>
            `;
            
            const profileContainer = document.querySelector('.profile-container');
            if (profileContainer) {
                profileContainer.innerHTML = profileHtml;
            }
            
            if (user.checkin_status) {
                updateCheckinStatusDisplay(user.checkin_status);
            } else {
                loadCheckinStatus();
            }
        }
        
        function updateCheckinStatusDisplay(checkinStatus) {
            const consecutiveDaysElement = document.getElementById('consecutiveDays');
            if (consecutiveDaysElement) {
                consecutiveDaysElement.textContent = checkinStatus.consecutive_days;
            }
            
            const monthlyCheckinsElement = document.getElementById('monthlyCheckins');
            if (monthlyCheckinsElement) {
                monthlyCheckinsElement.textContent = checkinStatus.monthly_checkins;
            }
            
            const checkinBtn = document.getElementById('checkinBtn');
            const checkinCompleted = document.getElementById('checkinCompleted');
            
            if (checkinStatus.has_checked_today) {
                if (checkinBtn) {
                    checkinBtn.disabled = true;
                    checkinBtn.innerHTML = '今日已签到';
                }
                if (checkinCompleted) {
                    checkinCompleted.classList.remove('d-none');
                }
            } else {
                if (checkinBtn) {
                    checkinBtn.disabled = false;
                    checkinBtn.innerHTML = '<i class="fas fa-calendar-check"></i> 今日签到';
                }
                if (checkinCompleted) {
                    checkinCompleted.classList.add('d-none');
                }
            }
        }
        
        function loadCheckinStatus() {
            fetch('api.php?action=get_checkin_status')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateCheckinStatusDisplay(data);
                    }
                })
                .catch(error => {
                    Logger.error('获取签到状态失败:', error);
                });
        }
        
        function updateVipStatus(data) {
            const statusContainer = document.getElementById('currentVipStatus');
            
            if (data.is_vip) {
                statusContainer.innerHTML = `
                    <div class="alert alert-warning mb-2">
                        <strong><i class="fas fa-crown"></i> 您当前是VIP会员</strong>
                        <p class="mb-0 small">到期时间: ${new Date(data.vip_expire_date).toLocaleDateString()}</p>
                    </div>
                    <p class="small">续费VIP可延长有效期</p>
                `;
            } else {
                statusContainer.innerHTML = `
                    <p>您还不是VIP会员</p>
                    <p class="small">开通VIP享受更多特权</p>
                `;
            }
            
            if (window.userInfo) {
                window.userInfo.is_vip = data.is_vip ? 1 : 0;
                window.userInfo.vip_expire_date = data.vip_expire_date;
            }
        }
        
        function bindVipButtons() {
            const vipButtons = document.querySelectorAll('.vip-status button[data-months]');
            
            vipButtons.forEach(button => {
                const newButton = button.cloneNode(true);
                button.parentNode.replaceChild(newButton, button);
            });
            
            const newVipButtons = document.querySelectorAll('.vip-status button[data-months]');
            
            newVipButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const months = parseInt(this.dataset.months);
                    const points = parseInt(this.dataset.points);
                    
                    if (window.userInfo && window.userInfo.points < points) {
                        showAlert(`积分不足，开通${months}个月VIP需要${points}积分，您当前积分为${window.userInfo.points}`, 'warning');
                        return;
                    }
                    
                    if (confirm(`确定要开通${months}个月VIP会员，需消耗${points}积分吗？`)) {
                        upgradeVip(months);
                    }
                });
            });
        }
        
        function upgradeVip(months) {
            const vipButtons = document.querySelectorAll('.vip-status button[data-months]');
            vipButtons.forEach(btn => btn.disabled = true);
            
            fetch('api.php?action=upgrade_vip', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({ months: months, level: 1 })
            })
            .then(response => response.text().then(text => {
                try {
                    return JSON.parse(text);
                } catch (e) {
                    Logger.error('JSON解析错误:', e);
                    throw new Error('服务器返回的数据格式不正确');
                }
            }))
            .then(data => {
                if (data.success) {
                    showAlert(data.message, 'success');
                    fetch('api.php?action=check_vip_status')
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                updateVipStatus(data);
                                setTimeout(() => bindVipButtons(), 100);
                            }
                        });
                    
                    fetch('api.php?action=user_info')
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                updateUserProfileDisplay(data);
                            }
                        });
                    
                    if (window.userInfo) {
                        window.userInfo.is_vip = 1;
                        window.userInfo.vip_level = 1;
                        window.userInfo.vip_expire_date = data.vip_expire_date;
                        
                        const userPoints = document.getElementById('userPoints');
                        const userPointsForVip = document.getElementById('userPointsForVip');
                        if (userPoints) userPoints.textContent = data.remaining_points;
                        if (userPointsForVip) userPointsForVip.textContent = data.remaining_points;
                        
                        const vipCheckinBonus = document.getElementById('vipCheckinBonus');
                        if (vipCheckinBonus) vipCheckinBonus.classList.remove('d-none');
                    }
                } else {
                    showAlert(data.message || '开通VIP失败，请稍后再试', 'danger');
                }
            })
            .catch(error => {
                Logger.error('Error during VIP upgrade:', error);
                showAlert('开通VIP失败，请刷新页面后重试', 'danger');
            })
            .finally(() => {
                vipButtons.forEach(btn => btn.disabled = false);
            });
        }
        
        function updatePointsConfigDisplay(data) {
            const checkinPoints = data.config.POINTS_PER_CHECKIN;
            const weeklyBonus = data.config.POINTS_PER_WEEKLY_CHECKIN;
            const vipBonus = data.config.POINTS_PER_VIP_CHECKIN;
            
            const checkinInfoElement = document.querySelector('.checkin-status p:nth-child(3)');
            if (checkinInfoElement) {
                checkinInfoElement.innerHTML = `签到可获得<strong>${checkinPoints}</strong>积分，连续签到7天额外奖励<strong>${weeklyBonus}</strong>积分！`;
            }
            
            const vipBonusElement = document.getElementById('vipCheckinBonus');
            if (vipBonusElement) {
                vipBonusElement.innerHTML = `<i class="fas fa-crown"></i> VIP会员每次签到额外获得<strong>${vipBonus}</strong>积分！`;
            }
        }
        
        function updateLimitsConfigDisplay(data) {
            const standardBottleLimit = data.config.DAILY_BOTTLE_LIMIT || 5;
            const standardPickLimit = data.config.DAILY_PICK_LIMIT || 5;
            const vipBottleLimit = data.config.VIP_DAILY_BOTTLE_LIMIT || 20;
            const vipPickLimit = data.config.VIP_DAILY_PICK_LIMIT || 20;
            
            const vipLimitsInfoElement = document.getElementById('vipLimitsInfo');
            if (vipLimitsInfoElement) {
                vipLimitsInfoElement.innerHTML = `
                    <li>普通用户每天可扔${standardBottleLimit}个瓶子、捡${standardPickLimit}个瓶子</li>
                    <li>VIP用户每天可扔${vipBottleLimit}个瓶子、捡${vipPickLimit}个瓶子</li>
                    <li>所有次数限制在每天0点自动刷新</li>
                    <li>特权随会员有效期同步，到期自动恢复为普通用户权限</li>
                `;
            }
        }
        
        function updateVipPointsConfigDisplay(data) {
            const vip1Month = data.config.VIP_POINTS_1_MONTH;
            const vip3Months = data.config.VIP_POINTS_3_MONTHS;
            const vip6Months = data.config.VIP_POINTS_6_MONTHS;
            const vip12Months = data.config.VIP_POINTS_12_MONTHS;
            
            const vipButtons = document.querySelectorAll('.vip-status button[data-months]');
            vipButtons.forEach(button => {
                const months = parseInt(button.getAttribute('data-months'));
                let points = 0;
                
                switch (months) {
                    case 1: points = vip1Month; break;
                    case 3: points = vip3Months; break;
                    case 6: points = vip6Months; break;
                    case 12: points = vip12Months; break;
                }
                
                if (points > 0) {
                    button.setAttribute('data-points', points);
                    const pointsDisplay = button.querySelector('div:nth-child(2)');
                    if (pointsDisplay) {
                        pointsDisplay.innerHTML = `<i class="fas fa-coins"></i> ${points}积分`;
                    }
                }
            });
        }
        
        function bindOtherEvents() {
            const updateSignatureBtn = document.getElementById('updateSignatureBtn');
            if (updateSignatureBtn && !updateSignatureBtn.hasEventListener) {
                updateSignatureBtn.hasEventListener = true;
                updateSignatureBtn.addEventListener('click', function() {
                    const signature = document.getElementById('signatureInput').value.trim();
                    
                    if (signature.length > 50) {
                        showAlert('签名最多50个字', 'warning');
                        return;
                    }
                    
                    this.disabled = true;
                    
                    fetch('api.php?action=update_signature', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ signature: signature })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showAlert('个性签名更新成功', 'success');
                            
                            if (window.userInfo) {
                                window.userInfo.signature = signature;
                            }
                            
                            const signatureElement = document.querySelector('.profile-container .row .col-md-6:first-child p:nth-of-type(3)');
                            if (signatureElement) {
                                if (signature) {
                                    signatureElement.textContent = `个性签名: ${signature}`;
                                    signatureElement.style.display = 'block';
                                } else {
                                    signatureElement.style.display = 'none';
                                }
                            } else if (signature) {
                                const profileCol = document.querySelector('.profile-container .row .col-md-6:first-child');
                                if (profileCol) {
                                    const signatureP = document.createElement('p');
                                    signatureP.textContent = `个性签名: ${signature}`;
                                    const timeElement = profileCol.querySelector('p:nth-of-type(2)');
                                    if (timeElement) {
                                        timeElement.insertAdjacentElement('afterend', signatureP);
                                    } else {
                                        profileCol.appendChild(signatureP);
                                    }
                                }
                            }
                        } else {
                            showAlert(data.message || '更新签名失败', 'danger');
                        }
                    })
                    .catch(error => {
                        Logger.error('Error:', error);
                        showAlert('更新签名失败，请稍后再试', 'danger');
                    })
                    .finally(() => {
                        this.disabled = false;
                    });
                });
            }
        }
        
        function updateNavBarManually() {
            const navbarContainer = document.querySelector('.navbar-nav');
            if (!navbarContainer) return;
            
            if (window.userInfo && window.userInfo.id) {
                navbarContainer.innerHTML = `
                    <li class="nav-item"><a href="index.html" class="nav-link">首页</a></li>
                    <li class="nav-item"><a href="throw.html" class="nav-link">扔漂流瓶</a></li>
                    <li class="nav-item"><a href="pick.html" class="nav-link">捡漂流瓶</a></li>
                    <li class="nav-item"><a href="profile_info.html" class="nav-link">个人中心</a></li>
                    <li class="nav-item"><a href="#" class="nav-link logout-btn">退出登录</a></li>
                `;
                
                const logoutBtn = document.querySelector('.logout-btn');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', async (e) => {
                        e.preventDefault();
                        try {
                            const response = await fetch('api.php?action=logout');
                            const data = await response.json();
                            if (data.success) {
                                window.location.href = 'login.html';
                            }
                        } catch (error) {
                            Logger.error('退出登录失败:', error);
                        }
                    });
                }
            } else {
                navbarContainer.innerHTML = `
                    <li class="nav-item"><a href="index.html" class="nav-link">首页</a></li>
                    <li class="nav-item"><a href="login.html" class="nav-link">登录</a></li>
                    <li class="nav-item"><a href="register.html" class="nav-link">注册</a></li>
                `;
            }
        }
        
        function showAlert(message, type = 'info') {
            let alertContainer = document.getElementById('alertContainer');
            
            if (!alertContainer) {
                alertContainer = document.createElement('div');
                alertContainer.id = 'alertContainer';
                alertContainer.className = 'alert-container';
                document.body.appendChild(alertContainer);
            }
            
            const alertId = 'alert-' + Date.now();
            const alertElement = document.createElement('div');
            alertElement.id = alertId;
            alertElement.className = `alert alert-${type} alert-dismissible fade show`;
            
            // 根据类型选择图标
            let icon = 'fa-info-circle';
            if (type === 'success') icon = 'fa-check-circle';
            else if (type === 'danger') icon = 'fa-exclamation-circle';
            else if (type === 'warning') icon = 'fa-exclamation-triangle';
            
            alertElement.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fas ${icon} me-2"></i>
                    <span>${message}</span>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            alertContainer.prepend(alertElement);
            
            // 自动关闭（成功消息3秒，其他5秒）
            const autoCloseTime = type === 'success' ? 3000 : 5000;
            setTimeout(() => {
                const alert = document.getElementById(alertId);
                if (alert) {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                }
            }, autoCloseTime);
        }
        
        // 充值相关功能
        let pointsRatio = 100; // 默认积分比例
        let availablePaymentMethods = ['alipay', 'wxpay', 'qqpay', 'bank']; // 默认支付方式
        let defaultPaymentMethod = 'alipay'; // 默认支付方式
        
        // 支付方式配置
        const paymentMethodConfig = {
            'alipay': {
                name: '支付宝',
                icon: 'fab fa-alipay',
                color: 'primary',
                class: 'btn-outline-primary'
            },
            'wxpay': {
                name: '微信支付',
                icon: 'fab fa-weixin',
                color: 'success',
                class: 'btn-outline-success'
            },
            'qqpay': {
                name: 'QQ钱包',
                icon: 'fab fa-qq',
                color: 'info',
                class: 'btn-outline-info'
            },
            'bank': {
                name: '云闪付',
                icon: 'fas fa-university',
                color: 'secondary',
                class: 'btn-outline-secondary'
            }
        };
        
        // 加载支付配置
        function loadPaymentConfig() {
            fetch('api.php?action=get_payment_config')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        pointsRatio = data.points_ratio;
                        const ratioDisplay = document.getElementById('pointsRatioDisplay');
                        if (ratioDisplay) {
                            ratioDisplay.textContent = pointsRatio;
                        }
                        
                        // 更新可用支付方式
                        if (data.available_methods && data.available_methods.length > 0) {
                            availablePaymentMethods = data.available_methods;
                        }
                        
                        // 更新默认支付方式
                        if (data.default_method) {
                            defaultPaymentMethod = data.default_method;
                        }
                        
                        // 渲染支付方式按钮
                        renderPaymentMethods();
                    }
                })
                .catch(error => {
                    Logger.error('加载支付配置失败:', error);
                    // 使用默认配置渲染
                    renderPaymentMethods();
                });
        }
        
        // 渲染支付方式按钮
        function renderPaymentMethods() {
            const container = document.getElementById('paymentMethodsContainer');
            if (!container) return;
            
            container.innerHTML = '';
            
            // 计算每行显示的列数（移动端2列，桌面端4列）
            const colsPerRow = availablePaymentMethods.length <= 2 ? 6 : (availablePaymentMethods.length <= 4 ? 6 : 4);
            
            availablePaymentMethods.forEach((method, index) => {
                const config = paymentMethodConfig[method];
                if (!config) return; // 跳过不支持的支付方式
                
                const isDefault = method === defaultPaymentMethod;
                const colDiv = document.createElement('div');
                colDiv.className = `col-${colsPerRow}`;
                
                colDiv.innerHTML = `
                    <input type="radio" class="btn-check payment-method-radio" 
                           name="paymentType" 
                           id="payment${method.charAt(0).toUpperCase() + method.slice(1)}" 
                           value="${method}" 
                           ${isDefault ? 'checked' : ''}>
                    <label class="btn ${config.class} payment-method-btn w-100" 
                           for="payment${method.charAt(0).toUpperCase() + method.slice(1)}">
                        <i class="${config.icon}"></i><br>
                        <small>${config.name}</small>
                    </label>
                `;
                
                container.appendChild(colDiv);
            });
            
            // 绑定选中状态变化事件
            container.querySelectorAll('.payment-method-radio').forEach(radio => {
                radio.addEventListener('change', function() {
                    updatePaymentMethodSelection();
                });
            });
            
            // 初始化选中状态
            setTimeout(() => {
                updatePaymentMethodSelection();
            }, 100);
        }
        
        // 更新支付方式选中状态显示
        function updatePaymentMethodSelection() {
            const container = document.getElementById('paymentMethodsContainer');
            if (!container) return;
            
            container.querySelectorAll('.payment-method-btn').forEach(btn => {
                const radio = document.getElementById(btn.getAttribute('for'));
                const method = radio ? radio.value : '';
                const config = paymentMethodConfig[method];
                
                if (!config) return;
                
                if (radio && radio.checked) {
                    // 选中状态：使用实心按钮样式
                    btn.classList.remove('btn-outline-primary', 'btn-outline-success', 'btn-outline-info', 'btn-outline-secondary');
                    btn.classList.add(`btn-${config.color}`);
                    btn.style.borderWidth = '2px';
                    btn.style.fontWeight = '600';
                    btn.style.transform = 'scale(1.05)';
                } else {
                    // 未选中状态：恢复outline样式
                    btn.classList.remove('btn-primary', 'btn-success', 'btn-info', 'btn-secondary');
                    btn.classList.add(config.class);
                    btn.style.borderWidth = '';
                    btn.style.fontWeight = '';
                    btn.style.transform = '';
                }
            });
        }
        
        // 计算预计积分
        function calculateExpectedPoints() {
            const amountInput = document.getElementById('rechargeAmount');
            const expectedPointsValue = document.getElementById('expectedPointsValue');
            
            if (amountInput && expectedPointsValue) {
                const amount = parseFloat(amountInput.value) || 0;
                const expectedPoints = Math.floor(amount * pointsRatio);
                expectedPointsValue.textContent = expectedPoints;
            }
        }
        
        // 绑定充值相关事件
        function bindRechargeEvents() {
            // 充值金额输入变化时计算预计积分
            const amountInput = document.getElementById('rechargeAmount');
            if (amountInput) {
                amountInput.addEventListener('input', calculateExpectedPoints);
            }
            
            // 确认充值按钮
            const confirmBtn = document.getElementById('confirmRechargeBtn');
            if (confirmBtn) {
                confirmBtn.addEventListener('click', function() {
                    const amount = parseFloat(document.getElementById('rechargeAmount').value);
                    const paymentType = document.querySelector('input[name="paymentType"]:checked')?.value || defaultPaymentMethod;
                    
                    if (!amount || amount < 0.01 || amount > 10000) {
                        showAlert('请输入有效的充值金额（0.01-10000元）', 'warning');
                        return;
                    }
                    
                    // 禁用按钮
                    this.disabled = true;
                    this.innerHTML = '<span class="spinner-border spinner-border-sm"></span> 处理中...';
                    
                    // 创建充值订单
                    fetch('api.php?action=create_recharge_order', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            amount: amount,
                            payment_type: paymentType
                        })
                    })
                    .then(async response => {
                        // 先获取响应文本，检查是否为有效JSON
                        const text = await response.text();
                        try {
                            return JSON.parse(text);
                        } catch (e) {
                            // 如果不是JSON，记录错误并抛出
                            Logger.error('API返回非JSON数据:', text);
                            throw new Error('服务器返回数据格式错误: ' + text.substring(0, 100));
                        }
                    })
                    .then(data => {
                        if (data && data.success) {
                            // 显示支付表单并自动提交
                            if (data.pay_html) {
                                // 先关闭弹窗
                                const modal = bootstrap.Modal.getInstance(document.getElementById('rechargeModal'));
                                if (modal) {
                                    modal.hide();
                                }
                                
                                // 创建临时容器解析HTML
                                const tempContainer = document.createElement('div');
                                tempContainer.innerHTML = data.pay_html;
                                
                                // 查找表单
                                const payForm = tempContainer.querySelector('#dopay');
                                
                                if (payForm) {
                                    // 将表单添加到body（隐藏）
                                    payForm.style.position = 'fixed';
                                    payForm.style.top = '-9999px';
                                    payForm.style.left = '-9999px';
                                    document.body.appendChild(payForm);
                                    
                                    // 立即提交表单
                                    setTimeout(() => {
                                        Logger.log('找到支付表单，准备提交');
                                        payForm.submit();
                                    }, 100);
                                } else {
                                    Logger.error('找不到支付表单，HTML内容:', data.pay_html.substring(0, 300));
                                    showAlert('支付表单加载失败，请刷新页面重试', 'danger');
                                    this.disabled = false;
                                    this.innerHTML = '<i class="fas fa-check"></i> 确认充值';
                                }
                            } else {
                                showAlert('支付表单生成失败', 'danger');
                                this.disabled = false;
                                this.innerHTML = '<i class="fas fa-check"></i> 确认充值';
                            }
                        } else {
                            const errorMsg = (data && data.message) ? data.message : '创建订单失败，请稍后再试';
                            showAlert(errorMsg, 'danger');
                            this.disabled = false;
                            this.innerHTML = '<i class="fas fa-check"></i> 确认充值';
                        }
                    })
                    .catch(error => {
                        Logger.error('创建充值订单失败:', error);
                        const errorMsg = error.message || '创建订单失败，请稍后再试';
                        showAlert(errorMsg, 'danger');
                        this.disabled = false;
                        this.innerHTML = '<i class="fas fa-check"></i> 确认充值';
                    });
                });
            }
            
            // 弹窗关闭时重置表单
            const rechargeModal = document.getElementById('rechargeModal');
            if (rechargeModal) {
                rechargeModal.addEventListener('hidden.bs.modal', function() {
                    document.getElementById('rechargeAmount').value = '';
                    document.getElementById('expectedPointsValue').textContent = '0';
                    document.getElementById('confirmRechargeBtn').disabled = false;
                    document.getElementById('confirmRechargeBtn').innerHTML = '<i class="fas fa-check"></i> 确认充值';
                });
            }
            
            // 充值记录弹窗打开时加载记录
            const rechargeHistoryModal = document.getElementById('rechargeHistoryModal');
            if (rechargeHistoryModal) {
                rechargeHistoryModal.addEventListener('show.bs.modal', function() {
                    loadRechargeHistory();
                });
            }
        }
        
        // 加载充值记录
        function loadRechargeHistory() {
            const loadingDiv = document.getElementById('rechargeHistoryLoading');
            const contentDiv = document.getElementById('rechargeHistoryContent');
            const tableBody = document.getElementById('rechargeHistoryTableBody');
            const cardBody = document.getElementById('rechargeHistoryCardBody');
            const emptyDiv = document.getElementById('rechargeHistoryEmpty');
            
            loadingDiv.classList.remove('d-none');
            contentDiv.classList.add('d-none');
            emptyDiv.classList.add('d-none');
            
            fetch('api.php?action=get_recharge_orders')
                .then(async response => {
                    const text = await response.text();
                    try {
                        return JSON.parse(text);
                    } catch (e) {
                        Logger.error('API返回非JSON数据:', text);
                        throw new Error('服务器返回数据格式错误');
                    }
                })
                .then(data => {
                    loadingDiv.classList.add('d-none');
                    
                    if (data.success && data.orders && data.orders.length > 0) {
                        contentDiv.classList.remove('d-none');
                        tableBody.innerHTML = '';
                        if (cardBody) cardBody.innerHTML = '';
                        
                        data.orders.forEach(order => {
                            const statusMap = {
                                0: '<span class="badge bg-warning">待支付</span>',
                                1: '<span class="badge bg-success">已支付</span>',
                                2: '<span class="badge bg-secondary">已取消</span>',
                                3: '<span class="badge bg-danger">已退款</span>'
                            };
                            
                            const paymentTypeMap = {
                                'alipay': '支付宝',
                                'wxpay': '微信支付',
                                'qqpay': 'QQ钱包',
                                'bank': '云闪付'
                            };
                            
                            const status = statusMap[order.status] || '<span class="badge bg-secondary">未知</span>';
                            const paymentType = paymentTypeMap[order.payment_type] || order.payment_type || '-';
                            const createdTime = order.created_at ? new Date(order.created_at).toLocaleString('zh-CN', {year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'}) : '-';
                            const paidTime = order.paid_at ? new Date(order.paid_at).toLocaleString('zh-CN', {year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'}) : '-';
                            
                            // 桌面端表格行
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td><small>${order.order_no}</small></td>
                                <td class="text-success fw-bold">¥${parseFloat(order.amount).toFixed(2)}</td>
                                <td><span class="text-warning fw-bold">${order.points}</span> 积分</td>
                                <td><small>${paymentType}</small></td>
                                <td>${status}</td>
                                <td><small>${createdTime}</small></td>
                            `;
                            tableBody.appendChild(row);
                            
                            // 移动端卡片
                            if (cardBody) {
                                const card = document.createElement('div');
                                card.className = 'card mb-2';
                                card.innerHTML = `
                                    <div class="card-body p-3">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <div>
                                                <small class="text-muted d-block">订单号</small>
                                                <code class="small">${order.order_no}</code>
                                            </div>
                                            ${status}
                                        </div>
                                        <div class="row g-2 mt-2">
                                            <div class="col-6">
                                                <small class="text-muted d-block">充值金额</small>
                                                <span class="text-success fw-bold">¥${parseFloat(order.amount).toFixed(2)}</span>
                                            </div>
                                            <div class="col-6">
                                                <small class="text-muted d-block">获得积分</small>
                                                <span class="text-warning fw-bold">${order.points} 积分</span>
                                            </div>
                                            <div class="col-6">
                                                <small class="text-muted d-block">支付方式</small>
                                                <small>${paymentType}</small>
                                            </div>
                                            <div class="col-6">
                                                <small class="text-muted d-block">创建时间</small>
                                                <small>${createdTime}</small>
                                            </div>
                                            ${order.paid_at ? `
                                            <div class="col-12">
                                                <small class="text-muted d-block">支付时间</small>
                                                <small>${paidTime}</small>
                                            </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                `;
                                cardBody.appendChild(card);
                            }
                        });
                    } else {
                        emptyDiv.classList.remove('d-none');
                    }
                })
                .catch(error => {
                    Logger.error('加载充值记录失败:', error);
                    loadingDiv.classList.add('d-none');
                    emptyDiv.classList.remove('d-none');
                    emptyDiv.innerHTML = `
                        <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                        <p class="text-danger">加载失败，请稍后再试</p>
                    `;
                });
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            if (window.profileInfoPageInitialized) {
                return;
            }
            window.profileInfoPageInitialized = true;
            
            Logger.init();
            initProfileInfoPage();
            
            // 加载支付配置
            loadPaymentConfig();
            
            // 绑定充值事件
            setTimeout(() => {
                bindRechargeEvents();
            }, 500);
        });
    </script>
</body>
</html>

